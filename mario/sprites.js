function resetCanvas(){window.canvas=getCanvas(innerWidth,innerHeight,!0),window.context=canvas.getContext("2d"),body.appendChild(canvas)}function spriteUnravel(e){for(var t,i,r,n=getPaletteReferenceStarting(window.palette),a=window.digitsize,s=e.length,l="",p=0;p<s;)switch(e[p]){case"x":for(r=e.indexOf(",",++p),t=makeDigit(n[e.slice(p,p+=a)],window.digitsize),i=Number(e.slice(p,r));i--;)l+=t;p=r+1;break;case"p":"["==e[++p]?(r=e.indexOf("]"),n=getPaletteReference(e.slice(p+1,r).split(",")),p=r+1,a=1):(n=getPaletteReference(window.palette),a=window.digitsize);break;default:l+=makeDigit(n[e.slice(p,p+=a)],window.digitsize)}return l}function spriteExpand(e){for(var t,i,r="",n=e.length,a=0;a<n;)for(t=e.slice(a,a+=digitsize),i=0;i<scale;++i)r+=t;return r}function spriteGetArray(e){var t,i,r,n,a=e.length/digitsize,s=e.match(new RegExp(".{1,"+digitsize+"}","g")),l=new Uint8ClampedArray(4*a);for(i=0,r=0;i<a;++i){for(t=palette[Number(s[i])],n=0;n<4;++n)l[r+n]=t[n];r+=4}return l}function setThingSprite(e){if(!e.hidden&&e.title){var t,i=library.cache,r=e.spritewidth,n=e.spriteheight;i[e.title+" "+e.className.split(/\s+/g).slice(1).sort()];(t=getSpriteFromLibrary(e))?t.multiple?(expandObtainedSpriteMultiple(t,e,r,n),e.sprite_type=t.type):(expandObtainedSprite(t,e,r,n),e.sprite_type="normal"):log("Could not get sprite from library on "+e.title)}}function getSpriteFromLibrary(e){var t,i,r,n,a=library.cache,s=e.title,l=e.libtype,p=e.className.split(/\s+/g).slice(1).sort(),o=(map.area||window.defaultsetting).setting.split(" ");for(n in o)p.unshift(o[n]);if(i=a[t=s+" "+p])r=i.raw;else{if(!(r=library.sprites[l][s])||!r.constructor)return;r.constructor!=Uint8ClampedArray&&(r=findSpriteInLibrary(e,r,p)),i=a[t]={raw:r}}switch(String(Number(p.indexOf("flipped")>=0))+String(Number(p.indexOf("flip-vert")>=0))){case"11":r=i.flipboth?i.flipboth:i.flipboth=flipSpriteArrayBoth(r);break;case"10":r=i.fliphoriz?i.fliphoriz:i.fliphoriz=flipSpriteArrayHoriz(r,e);break;case"01":r=i.flipvert?i.flipvert:i.flipvert=flipSpriteArrayVert(r,e);break;default:r=i.raw}return r}function expandObtainedSprite(e,t,i,r,n){var a,s,l=new Uint8ClampedArray(e.length*scale),p=i*unitsizet4,o=r*scale,c=0,f=0;for(a=0;a<o;++a){for(s=0;s<scale;++s)memcpyU8(e,l,c,f,p),f+=p;c+=p}return n||(t.num_sprites=1,t.sprite=l,refillThingCanvas(t)),l}function expandObtainedSpriteMultiple(e,t,i,r){var n,a,s={};for(a in t.num_sprites=0,e)(n=e[a]).constructor==Uint8ClampedArray?(++t.num_sprites,s[a]=expandObtainedSprite(n,t,i,r,!0)):s[a]="number"==typeof n?n*scale:n;t.sprite=s.middle,t.sprites=s,refillThingCanvases(t,s)}function findSpriteInLibrary(e,t,i){var r,n,a;if(t.multiple)return t;for(var s=0;r=!0;){for(a in++s>49&&alert(e.title),i)if(n=t[i[a]]){t=n,i.splice(a,1),r=!1;break}if(r)if(n=t.normal)switch(r=!1,n.constructor){case Uint8ClampedArray:case SpriteMultiple:return n;case Object:t=n;break;default:t=t[n]}else r=!0;if(r||!t)return new Uint8ClampedArray(e.spritewidth*e.spriteheight);switch(t.constructor){case Uint8ClampedArray:case SpriteMultiple:return t;case"Object":continue}}}function refillThingCanvas(e){var t=e.canvas,i=e.context,r=i.getImageData(0,0,t.width,t.height);memcpyU8(e.sprite,r.data),i.putImageData(r,0,0)}function refillThingCanvases(e,t){var i,r,n,a,s,l=e.canvases={},p=e.spritewidthpixels,o=e.spriteheightpixels;for(s in e.num_sprites=1,t)(i=t[s])instanceof Uint8ClampedArray?(++e.num_sprites,l[s]=n={canvas:getCanvas(p,o)},n.context=a=n.canvas.getContext("2d"),memcpyU8(i,(r=a.getImageData(0,0,p,o)).data),a.putImageData(r,0,0)):l[s]=i;n=l.middle,e.canvas=n.canvas,e.context=n.context}function refillCanvas(){var e,t=window.canvas,i=window.context;for(i.fillStyle=area.fillStyle,i.fillRect(0,0,t.width,t.height),e=scenery.length-1;e>=0;--e)drawThingOnCanvas(i,scenery[e]);for(e=solids.length-1;e>=0;--e)drawThingOnCanvas(i,solids[e]);for(e=characters.length-1;e>=0;--e)drawThingOnCanvas(i,characters[e])}function drawThingOnCanvas(e,t){if(!t.hidden){var i=t.left,r=t.top;i>innerWidth||(1==t.num_sprites?drawThingOnCanvasSingle(e,t.canvas,t,i,r):drawThingOnCanvasMultiple(e,t.canvases,t.canvas,t,i,r))}}function drawThingOnCanvasSingle(e,t,i,r,n){i.repeat?drawPatternOnCanvas(e,t,r,n,i.unitwidth,i.unitheight):e.drawImage(t,r,n)}function drawThingOnCanvasMultiple(e,t,i,r,n,a){var s,l,p=a,o=n,c=r.right,f=r.bottom,d=r.unitwidth,h=r.unitheight,g=r.spritewidthpixels,u=r.spriteheightpixels;"v"==r.sprite_type[0]?((l=t.bottom)&&(s=t.bottomheight||r.spriteheightpixels,drawPatternOnCanvas(e,l.canvas,o,f-s,g,min(h,u)),f-=s,h-=s),(l=t.top)&&(s=t.topheight||r.spriteheightpixels,drawPatternOnCanvas(e,l.canvas,o,p,g,min(h,u)),p+=s,h-=s)):"h"==r.sprite_type[0]&&((l=t.left)&&(s=t.leftwidth||r.spritewidthpixels,drawPatternOnCanvas(e,l.canvas,o,p,min(d,g),u),o+=s,d-=s),(l=t.right)&&(s=t.rightwidth||r.spritewidthpixels,drawPatternOnCanvas(e,l.canvas,c-s,p,min(d,g),u),c-=s,d-=s)),p<f&&o<c&&drawPatternOnCanvas(e,i,o,p,d,h)}function getPaletteReferenceStarting(e){for(var t={},i=0;i<e.length;++i)t[makeDigit(i,digitsize)]=makeDigit(i,digitsize);return t}function getPaletteReference(e){for(var t={},i=getDigitSize(e),r=0;r<e.length;++r)t[makeDigit(r,i)]=makeDigit(e[r],i);return t}function flipSpriteArrayHoriz(e,t){var i,r,n,a,s,l=e.length,p=t.spritewidth,o=(t.spriteheight,new Uint8ClampedArray(l)),c=p*unitsizet4;for(n=0;n<l;n+=c)for(i=n,r=n+c-4,a=0;a<c;a+=4){for(s=0;s<4;++s)o[i+s]=e[r+s];i+=4,r-=4}return o}function flipSpriteArrayVert(e,t){for(var i,r,n=e.length,a=t.spritewidth,s=(t.spriteheight,new Uint8ClampedArray(n)),l=a*unitsizet4,p=0,o=n-l;p<n;){for(i=0;i<l;i+=4)for(r=0;r<4;++r)s[p+i+r]=e[o+i+r];p+=l,o-=l}return s}function flipSpriteArrayBoth(e){for(var t,i=e.length,r=new Uint8ClampedArray(i),n=e.length-4,a=0;a<i;){for(t=0;t<4;++t)r[a+t]=e[n+t];a+=4,n-=4}return r}function drawPatternOnCanvas(e,t,i,r,n,a){e.translate(i,r),e.fillStyle=e.createPattern(t,"repeat"),e.fillRect(0,0,n,a),e.translate(-i,-r)}function clearAllSprites(e){var t,i,r=[window.solids,window.characters,window.scenery];for(t in r)for(i in t=r[t])setThingSprite(t[i]);e&&(library.cache={})}function memcpyU8(e,t,i,r,n){if(!(!e||!t||i<0||r<0||n<=0||i>=e.length||r>=t.length)){null==i&&(i=0),null==r&&(r=0),null==n&&(n=max(0,min(e.length,t.length)));for(var a=n+0,s=r+0,l=i+0;a--;)t[s++]=e[l++]}}function canvasDisableSmoothing(e,t){(t=t||e.getContext("2d")).webkitImageSmoothingEnabled=!1,t.mozImageSmoothingEnabled=!1,t.imageSmoothingEnabled=!1}