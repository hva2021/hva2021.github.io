function Thing(e){if(0!=arguments.length&&e){var t=this===window?new Thing:this,i=t.args=arrayMake(arguments);i[0]=t,e.apply(t,i),t.alive=!0,t.placed=this.outerok=0,t.xvel=this.xvel||0,t.yvel=this.yvel||0,null==t.tolx&&(t.tolx=0),null==t.toly&&(t.toly=unitsized8),t.collide=t.collide||function(){},t.death=t.death||killNormal,t.animate=t.animate||emergeUp;var n,l=4;(n=floor(t.width*unitsize/QuadsKeeper.getQuadWidth()))>0&&(l+=(n+1)*l/2),(n=floor(t.height*unitsize/QuadsKeeper.getQuadHeight()))>0&&(l+=(n+1)*l/2),t.maxquads=l,t.quadrants=new Array(t.maxquads),t.overlaps=[],t.title=t.title||e.name,t.spritewidth=t.spritewidth||t.width,t.spriteheight=t.spriteheight||t.height,t.sprite="";try{setContextStuff(t,t.spritewidth,t.spriteheight)}catch(e){log("Thing context fail",e,t.title,t),setTimeout((function(){setContextStuff(t,t.spritewidth,t.spriteheight)}),1)}return t}}function setContextStuff(e,t,i){e.spritewidthpixels=e.spritewidth*unitsize,e.spriteheightpixels=e.spriteheight*unitsize,e.canvas=getCanvas(e.spritewidthpixels,e.spriteheightpixels),e.context=e.canvas.getContext("2d"),e.imageData=e.context.getImageData(0,0,e.spritewidthpixels,e.spriteheightpixels),e.sprite_type=e.sprite_type||"neither",canvasDisableSmoothing(e,e.context)}function ThingCreate(e,t){var i=new Thing;return Thing.apply(i,[e].concat(t)),i}function setCharacter(e,t){e.type=t.split(" ")[0],e.resting=e.under=e.undermid=!1,e.alive=e.character=!0,e.libtype="characters",setClassInitial(e,"character "+t)}function setSolid(e,t){e.type="solid",e.name=t,e.solid=e.alive=!0,e.speed=e.speed||0,e.collide=e.collide||characterTouchedSolid,e.bottomBump=e.bottomBump||function(){},e.action=e.action||function(){},e.jump=e.jump||function(){},e.spritewidth=e.spritewidth||8,e.spriteheight=e.spriteheight||8,e.libtype="solids",setClassInitial(e,"solid "+t)}function setScenery(e,t){setSolid(e,t),e.libtype="scenery"}function addThing(e,t,i){return e instanceof Function&&(e=new Thing(e)),placeThing(e,t,i),window[e.libtype].push(e),e.placed=!0,e.onadding&&e.onadding(),setThingSprite(e),window["last_"+(e.title||e.group||"unknown")]=e,e}function placeThing(e,t,i){return setLeft(e,t),setTop(e,i),updateSize(e),e}function addText(e,t,i){var n=createElement("div",{innerHTML:e,className:"text",left:t,top:i,onclick:body.onclick||canvas.onclick,style:{marginLeft:t+"px",marginTop:i+"px"}});return body.appendChild(n),texts.push(n),n}function spawnText(e,t){var i=e.element=addText("",e.left,e.top);"object"==typeof t?proliferate(i,t):i.innerHTML=t,e.movement=!1}function checkTexts(){var e,t,i,n=QuadsKeeper.getDelX();for(i=texts.length-1;i>=0;--i)t=texts[i],e=texts[i].element||t,t.right=t.left+e.clientWidth,t.right<n&&(body.removeChild(e),killNormal(t),deleteThing(e,texts,i))}function Mushroom(e,t){e.group="item",e.width=e.height=8,e.speed=.42*unitsize,e.animate=emergeUp,e.movement=moveSimple,e.collide=collideFriendly,e.jump=mushroomJump,e.death=killNormal,e.nofire=!0;var i="mushroom";switch(t){case 1:e.action=gainLife,i+=" gainlife";break;case-1:e.action=killPlayer,i+=" death";break;default:e.action=playerShroom,i+=" regular"}setCharacter(e,i)}function mushroomJump(e){e.yvel-=1.4*unitsize,e.top-=unitsize,e.bottom-=unitsize,updatePosition(e)}function FireFlower(e){e.group="item",e.width=e.height=8,e.animate=emergeUp,e.collide=collideFriendly,e.action=playerShroom,e.nofall=e.nofire=!0,e.movement=!1,setCharacter(e,"fireflower"),TimeHandler.addSpriteCycle(e,["one","two","three","four"])}function FireBall(e,t){e.group="item",e.width=e.height=4,e.speed=1.75*unitsize,e.gravity=1.56*gravity,e.jumpheight=1.56*unitsize,e.nofire=e.nostar=e.collide_primary=!0,e.moveleft=t,e.animate=emergeFire,e.movement=moveJumping,e.collide=fireEnemy,e.death=fireExplodes,setCharacter(e,"fireball"),TimeHandler.addSpriteCycle(e,["one","two","three","four"],4)}function fireEnemy(e,t){if(!(!t.alive||t.emerging||e.height<=unitsize)){if(e.nofire)return e.nofire>1?t.death(t):void 0;e.solid?AudioPlayer.playLocal("Bump",t.right):(AudioPlayer.playLocal("Kick",t.right),e.death(e,2),scoreEnemyFire(e)),t.death(t)}}function fireDeleted(){--player.numballs}function fireExplodes(e){var t=new Thing(Firework);addThing(t,e.left-t.width/2,e.top-t.height/2),t.animate(),killNormal(e)}function Star(e){e.group="item",e.width=7,e.height=8,e.speed=.56*unitsize,e.jumpheight=1.17*unitsize,e.gravity=gravity/2.8,e.animate=emergeUp,e.movement=moveJumping,e.collide=collideFriendly,e.action=playerStar,e.death=killNormal,e.nofire=!0,setCharacter(e,"star item"),TimeHandler.addSpriteCycle(e,["one","two","three","four"],0,7)}function Shell(e,t){e.width=8,e.height=7,e.group="item",e.speed=unitsizet2,e.collide_primary=!0,e.moveleft=e.xvel=e.move=e.hitcount=e.peeking=e.counting=e.landing=e.enemyhitcount=0,e.smart=t,e.movement=moveShell,e.collide=hitShell,e.death=killFlip,e.spawntype=Koopa,setCharacter(e,"shell"+(t?" smart":" dumb"))}function hitShell(e,t){if("shell"==e.type&&t.type!=e.type)return hitShell(t,e);switch(e.type){case"solid":t.right<e.right?(AudioPlayer.playLocal("Bump",e.left),setRight(t,e.left),t.xvel=-t.speed,t.moveleft=!0):(AudioPlayer.playLocal("Bump",e.right),setLeft(t,e.right),t.xvel=t.speed,t.moveleft=!1);break;case"player":var i=objectToLeft(t,e),n=e.yvel>0&&e.bottom<=t.top+unitsizet2;if(e.star)return scorePlayerShell(e,t),t.death(t,2);if(t.landing)return void(t.shelltoleft==i?(++t.landing,1==t.landing&&scorePlayerShell(e,t),TimeHandler.addEvent((function(e){--e.landing}),2,t)):player.death(player));0==t.xvel||n?(t.counting=0,scorePlayerShell(e,t),t.peeking&&(t.peeking=!1,removeClass(t,"peeking"),t.height-=unitsized8,updateSize(t)),0==t.xvel?(i?(t.moveleft=!0,t.xvel=-t.speed):(t.moveleft=!1,t.xvel=t.speed),++t.hitcount,TimeHandler.addEvent((function(e){--e.hitcount}),2,t)):t.xvel=0,n&&(AudioPlayer.play("Kick"),t.xvel?scorePlayerShell(e,t):(jumpEnemy(e,t),e.yvel*=2,scorePlayerShell(e,t),setBottom(e,t.top-unitsize,!0)),++t.landing,t.shelltoleft=i,TimeHandler.addEvent((function(e){--e.landing}),2,t))):!t.hitcount&&(i&&t.xvel<0||!i&&t.xvel>0)&&e.death(e);break;case"shell":if(0!=e.xvel)if(0!=t.xvel){var l=e.xvel;shiftHoriz(e,e.xvel=t.xvel),shiftHoriz(t,t.xvel=l)}else score(t,500),t.death(t);else 0!=t.xvel&&(score(e,500),e.death(e));break;default:switch(e.group){case"enemy":if(t.xvel){if("koopa"==e.type.split(" ")[0]){var o=new Thing(Shell,e.smart);addThing(o,e.left,e.bottom-o.height*unitsize),killFlip(o),killNormal(e)}else killFlip(e);AudioPlayer.play("Kick"),score(e,findScore(t.enemyhitcount),!0),++t.enemyhitcount}else e.moveleft=objectToLeft(e,t);break;case"item":if("shell"!=e.type)return;t.xvel&&killFlip(e),e.xvel&&killFlip(t)}}}function moveShell(e){if(0==e.xvel)if(350==++e.counting)addClass(e,"peeking"),e.peeking=!0,e.height+=unitsized8,updateSize(e);else if(490==e.counting){var t=new Thing(e.spawntype,e.smart);addThing(t,e.left,e.bottom-t.height*unitsize),killNormal(e)}}function collideFriendly(e,t){"player"==e.type&&(t.action&&t.action(e),t.death(t))}function jumpEnemy(e,t){e.keys.up?e.yvel=-1.4*unitsize:e.yvel=-.7*unitsize,e.xvel*=.91,AudioPlayer.play("Kick"),"item"==t.group&&"shell"!=t.type||score(t,findScore(e.jumpcount+++e.jumpers),!0),++e.jumpers,TimeHandler.addEvent((function(e){--e.jumpers}),1,e)}function Goomba(e){e.width=e.height=8,e.speed=.21*unitsize,e.toly=unitsize,e.moveleft=e.noflip=!0,e.smart=!1,e.group="enemy",e.movement=moveSimple,e.collide=collideEnemy,e.death=killGoomba,setCharacter(e,"goomba"),TimeHandler.addSpriteCycleSynched(e,[unflipHoriz,flipHoriz])}function killGoomba(e,t){if(e.alive)if(t)killFlip(e);else{var i=new Thing(DeadGoomba);addThing(i,e.left,e.bottom-i.height*unitsize),TimeHandler.addEvent(killNormal,21,i),killNormal(e)}}function DeadGoomba(e){e.width=8,e.height=4,e.movement=!1,e.nocollide=e.nocollide=!0,e.death=killNormal,setSolid(e,"deadGoomba")}function Koopa(e,t,i){e.width=8,e.height=12,e.speed=e.xvel=.21*unitsize,e.moveleft=e.skipoverlaps=!0,e.group="enemy",e.smart=t;var n="koopa";n+=e.smart?" smart":" dumb",e.smart&&(n+=" smart"),i?(n+=" flying",e.winged=!0,1==i?(e.movement=moveJumping,e.jumpheight=1.17*unitsize,e.gravity=gravity/2.8):(e.movement=moveFloating,e.ytop=e.begin=i[0]*unitsize,e.ybot=e.end=i[1]*unitsize,e.nofall=e.fly=!0,e.changing=e.xvel=0,e.yvel=e.maxvel=unitsized4)):(n+=" regular",e.smart?e.movement=moveSmart:e.movement=moveSimple),e.collide=collideEnemy,e.death=killKoopa,setCharacter(e,n),TimeHandler.addSpriteCycleSynched(e,["one","two"]),e.toly=unitsizet2}function killKoopa(e,t){if(e.alive){var i;if(i=t&&2!=t||e.winged?new Thing(Koopa,e.smart):new Thing(Shell,e.smart),TimeHandler.addEvent((function(e,t){addThing(e,t.left,t.bottom-e.height*unitsize),e.moveleft=t.moveleft}),0,i,e),killNormal(e),2!=t)return i;killFlip(i)}}function Pirhana(e,t){e.width=8,e.height=12,e.counter=0,e.countermax=e.height*unitsize,e.dir=unitsized8,e.toly=unitsizet8,e.nofall=e.deadly=e.nocollidesolid=e.repeat=!0,e.group="enemy",e.collide=collideEnemy,e.death=killNormal,e.movement=movePirhanaInit,e.death=killPirhana,setCharacter(e,"pirhana")}function movePirhanaInit(e){e.hidden=!0;var t=e.visual_scenery=new Thing(Sprite,"Pirhana");addThing(t,e.left,e.top),TimeHandler.addSpriteCycle(t,["one","two"]),e.movement=movePirhanaNew,movePirhanaNew(e,e.height*unitsize)}function movePirhanaNew(e,t){t=t||e.dir,e.counter+=t,shiftVert(e,t),shiftVert(e.visual_scenery,t),(e.counter<=0||e.counter>=e.countermax)&&(e.movement=!1,e.dir*=-1,TimeHandler.addEvent(movePirhanaRestart,35,e))}function movePirhanaRestart(e){var t=getMidX(player);e.counter>=e.countermax&&t>e.left-unitsizet8&&t<e.right+unitsizet8?setTimeout(movePirhanaRestart,7,e):e.movement=movePirhanaNew}function killPirhana(e){(e||(e=this))&&(killNormal(e),killNormal(e.visual_scenery))}function playerAboveEnemy(e,t){return e.bottom<t.top+t.toly}function collideEnemy(e,t){if(characterIsAlive(e)&&characterIsAlive(t)&&!(e.nocollidechar&&!t.player||t.nocollidechar&&!e.player)){if("item"==e.group)return e.collide_primary?e.collide(t,e):void 0;if(!map.underwater&&e.player&&(e.star&&!t.nostar||!t.deadly&&objectOnTop(e,t))){if(playerAboveEnemy(e,t))return;e.player&&!e.star?TimeHandler.addEvent((function(e,t){jumpEnemy(e,t)}),0,e,t):t.nocollide=!0;t.death(t,2*e.star);e.star?scoreEnemyStar(t):(scoreEnemyStomp(t),setBottom(e,min(e.bottom,t.top+unitsize))),addClass(e,"hopping"),removeClasses(e,"running skidding jumping one two three"),e.hopping=!0,1==player.power&&setPlayerSizeSmall(e)}else e.player?playerAboveEnemy(e,t)||e.death(e):t.moveleft=!(e.moveleft=objectToLeft(e,t))}}function Podoboo(e,t){e.width=7,e.height=8,e.deadly=e.nofall=e.nocollidesolid=e.nofire=!0,e.gravity=map.gravity/2.1,e.jumpheight=(t||64)*unitsize,e.speed=-map.maxyvel,e.movement=movePodobooInit,e.collide=collideEnemy,e.betweentime=70,setCharacter(e,"podoboo")}function movePodobooInit(e){characterIsAlive(e)&&(e.hidden=!0,e.heightnorm=e.top,e.heightfall=e.top-e.jumpheight,TimeHandler.addEvent(podobooJump,e.betweentime,e),e.movement=!1)}function podobooJump(e){characterIsAlive(e)&&(unflipVert(e),e.yvel=e.speed+e.gravity,e.movement=movePodobooUp,e.hidden=!1,setThingSprite(e))}function movePodobooUp(e){shiftVert(e,e.speed,!0),e.top-gamescreen.top>e.heightfall||(e.nofall=!1,e.movement=movePodobooSwitch)}function movePodobooSwitch(e){e.yvel<=0||(flipVert(e),e.movement=movePodobooDown)}function movePodobooDown(e){e.top<e.heightnorm||(setTop(e,e.heightnorm,!0),e.movement=!1,e.nofall=e.hidden=!0,e.heightfall=e.top-e.jumpheight,TimeHandler.addEvent(podobooJump,e.betweentime,e))}function HammerBro(e){e.width=8,e.height=12,e.group="enemy",e.collide=collideEnemy,e.statex=e.counter=e.statey=e.counterx=e.countery=e.level=e.throwcount=0,e.death=killFlip,e.movement=moveHammerBro,setCharacter(e,"hammerbro"),e.gravity=gravity/2,TimeHandler.addSpriteCycle(e,["one","two"]),TimeHandler.addEvent(throwHammer,35,e,7),TimeHandler.addEventInterval(jumpHammerBro,140,1/0,e)}function moveHammerBro(e){e.xvel=Math.sin(Math.PI*(e.counter+=.007))/2.1,lookTowardPlayer(e),e.nocollidesolid=e.yvel<0||e.falling}function throwHammer(e,t){!characterIsAlive(e)||e.nothrow||e.right<-unitsizet32||(3!=t&&switchClass(e,"thrown","throwing"),TimeHandler.addEvent((function(e){if(3!=t){if(!characterIsAlive(e))return;switchClass(e,"throwing","thrown"),addThing(new Thing(Hammer,e.lookleft),e.left-unitsizet2,e.top-unitsizet2)}t>0?TimeHandler.addEvent(throwHammer,7,e,--t):(TimeHandler.addEvent(throwHammer,70,e,7),removeClass(e,"thrown"))}),14,e))}function jumpHammerBro(e){if(!characterIsAlive(e))return!0;e.resting&&(map.floor-e.bottom/unitsize>=jumplev1-2&&"floor"!=e.resting.name&&Math.floor(2*Math.random())?(e.yvel=-.7*unitsize,e.falling=!0,TimeHandler.addEvent((function(e){e.falling=!1}),42,e)):e.yvel=-2.1*unitsize,e.resting=!1)}function Hammer(e,t){e.width=e.height=8,e.nocollidesolid=e.nocollidechar=e.deadly=e.nofire=!0,e.collide=collideEnemy,e.yvel=1.4*-unitsize,e.xvel=unitsize/1.4,t&&(e.xvel*=-1),e.gravity=gravity/2.1,setCharacter(e,"hammer"),TimeHandler.addSpriteCycle(e,["one","two","three","four"],3)}function Cannon(e,t,i){e.width=8,e.height=8*(t||1),e.spriteheight=16,i||(e.movement=moveCannonInit),e.timer=117,e.repeat=!0,setSolid(e,"cannon")}function moveCannonInit(e){TimeHandler.addEventInterval((function(e){if(!(player.right>e.left-unitsizet8&&player.left<e.right+unitsizet8)){var t=new Thing(BulletBill);objectToLeft(player,e)?(addThing(t,e.left,e.top),t.direction=t.moveleft=!0,t.xvel*=-1,flipHoriz(t)):addThing(t,e.left+e.width,e.top),AudioPlayer.playLocal("Bump",e.right)}}),270,1/0,e),e.movement=!1}function BulletBill(e){e.width=8,e.height=7,e.group="enemy",e.nofall=e.nofire=e.nocollidesolid=e.nocollidechar=!0,e.speed=e.xvel=unitsized2,e.movement=moveSimple,e.collide=collideEnemy,e.death=killFlip,setCharacter(e,"bulletbill")}function Bowser(e,t){e.width=e.height=16,e.speed=.28*unitsize,e.gravity=gravity/2.8,e.deadly=e.dx=e.lookleft=e.nokillend=e.skipoverlaps=!0,e.moveleft=e.smart=e.movecount=e.jumpcount=e.firecount=e.deathcount=0,e.killonend=freezeBowser,e.counter=-.7,e.group="enemy",e.movement=moveBowserInit,e.collide=collideEnemy,e.death=killBowser,setCharacter(e,"bowser"),TimeHandler.addSpriteCycle(e,["one","two"]),t&&TimeHandler.addEvent(throwHammer,35,e,7)}function moveBowserInit(e){TimeHandler.addEventInterval(bowserJumps,117,1/0,e),TimeHandler.addEventInterval(bowserFires,280,1/0,e),TimeHandler.addEventInterval(bowserFires,350,1/0,e),TimeHandler.addEventInterval(bowserFires,490,1/0,e),e.movement=moveBowser}function moveBowser(e){characterIsAlive(player)&&(lookTowardPlayer(e),e.lookleft?e.xvel=Math.sin(Math.PI*(e.counter+=.007))/1.4:e.xvel=min(e.xvel+.07,.84))}function bowserJumps(e){if(!characterIsAlive(e))return!0;e.resting&&e.lookleft&&(e.yvel=-1.4*unitsize,e.resting=!1,e.nocollidesolid=!0,TimeHandler.addEventInterval((function(e){if(e.yvel>unitsize)return e.nocollidesolid=!1,!0}),3,1/0,e))}function bowserFires(e){if(!characterIsAlive(e)||!characterIsAlive(player))return!0;e.lookleft&&(addClass(e,"firing"),AudioPlayer.playLocal("Bowser Fires",e.left),TimeHandler.addEvent((function(e){var t=e.top+unitsizet4,i=new Thing(BowserFire,roundDigit(player.bottom,unitsizet8));removeClass(e,"firing"),addThing(i,e.left-unitsizet8,t),AudioPlayer.play("Bowser Fires")}),14,e))}function killBowser(e,t){if(t)return e.nofall=!1,killFlip(e);5==++e.deathcount&&(e.yvel=e.speed=e.movement=0,killFlip(e,350),score(e,5e3))}function freezeBowser(e){e.movement=!1,thingStoreVelocity(e)}function BowserFire(e,t){e.width=12,e.height=4,e.xvel=-.63*unitsize,e.deadly=e.nofall=e.nocollidesolid=e.nofire=!0,e.collide=collideEnemy,t&&(e.ylev=t,e.movement=moveFlying),setCharacter(e,"bowserfire"),TimeHandler.addSpriteCycle(e,[unflipVert,flipVert])}function moveFlying(e){round(e.bottom)!=round(e.ylev)?shiftVert(e,min(max(0,e.ylev-e.bottom),unitsize)):e.movement=!1}function WaterBlock(e,t){e.height=16,e.width=t,e.spritewidth=e.spriteheight=1/scale,e.repeat=!0,setSolid(e,"water-block")}function Blooper(e){e.width=8,e.height=12,e.nocollidesolid=e.nofall=e.moveleft=1,e.squeeze=e.counter=0,e.speed=unitsized2,e.xvel=e.speedinv=-unitsized4,e.movement=moveBlooper,e.collide=collideEnemy,e.death=killFlip,setCharacter(e,"blooper")}function moveBlooper(e){switch(e.counter){case 56:e.squeeze=!0,++e.counter;break;case 63:squeezeBlooper(e);break;default:++e.counter}e.top<unitsizet16+10&&squeezeBlooper(e),e.squeeze?e.yvel=max(e.yvel+.021,.7):e.yvel=min(e.yvel-.035,-.7),shiftVert(e,e.yvel,!0),e.squeeze||(player.left>e.right+unitsizet8?e.xvel=min(e.speed,e.xvel+unitsized32):player.right<e.left-unitsizet8&&(e.xvel=max(e.speedinv,e.xvel-unitsized32)))}function squeezeBlooper(e){2!=e.squeeze&&addClass(e,"squeeze"),e.squeeze=2,e.xvel/=1.17,setHeight(e,10,!0,!0),(e.top>player.bottom||e.bottom>360)&&unsqueezeBlooper(e)}function unsqueezeBlooper(e){e.squeeze=!1,removeClass(e,"squeeze"),e.counter=0,setHeight(e,12,!0,!0)}function CheepCheep(e,t,i){e.width=e.height=8,e.group="enemy";var n="cheepcheep "+(t?"red":"");e.red=t,setCheepVelocities(e),i?(n+=" jumping",e.jumping=!0,e.movement=moveCheepJumping):e.movement=moveCheepInit,e.nofall=e.nocollidesolid=e.nocollidechar=!0,e.death=killFlip,e.collide=collideEnemy,setCharacter(e,n),TimeHandler.addSpriteCycle(e,["one","two"])}function setCheepVelocities(e){e.red?(e.xvel=-unitsized4,e.yvel=unitsize/-24):(e.xvel=unitsize/-6,e.yvel=-unitsized32)}function moveCheepInit(e){setCheepVelocities(e),e.top<player.top&&(e.yvel*=-1),moveCheep(e),e.movement=moveCheep}function moveCheep(e){shiftVert(e,e.yvel)}function moveCheepJumping(e){shiftVert(e,e.yvel+=unitsize/14)}function startCheepSpawn(){return map.zone_cheeps=TimeHandler.addEventInterval((function(){if(!map.zone_cheeps)return!0;var e=new Thing(CheepCheep,!0,!0);addThing(e,Math.random()*player.left*player.maxspeed/unitsized2,gamescreen.height*unitsize),e.xvel=Math.random()*player.maxspeed,e.yvel=-2.33*unitsize,flipHoriz(e),e.movement=function(e){e.top<ceilmax?e.movement=moveCheepJumping:shiftVert(e,e.yvel)}}),21,1/0)}function Bubble(e){e.width=e.height=2,e.nofall=e.nocollide=!0,e.movement=function(e){e.top<unitsizet16?killNormal(e):shiftVert(e,e.yvel)},e.yvel=-unitsized4,setCharacter(e,"bubble")}function Lakitu(e,t){e.width=8,e.height=12,e.nofall=e.noshiftx=e.nocollidesolid=!0,e.playerdiff=e.counter=0,e.dir=-1,e.norepeat=t,e.playerdiff=unitsizet16,e.group="enemy",e.collide=collideEnemy,e.movement=moveLakituInit,e.death=killLakitu,setCharacter(e,"lakitu out"),map.has_lakitu=e}function moveLakituInit(e){if(map.has_lakitu&&e.norepeat)return killNormal(e);TimeHandler.addEventInterval((function(e){if(!e.alive)return!0;throwSpiny(e)}),140,1/0,e),e.movement=moveLakituInit2,moveLakituInit2(e),map.has_lakitu=e}function moveLakituInit2(e){if(e.right<player.left)return moveLakitu(e),e.movement=moveLakitu,map.lakitu=e,!0;shiftHoriz(e,-unitsize)}function moveLakitu(e){player.xvel>unitsized8&&player.left>gamescreen.width*unitsized2?e.left<player.right+unitsizet16&&(slideToXLoc(e,player.right+unitsizet32+player.xvel,1.4*player.maxspeed),e.counter=0):(e.counter+=.007,slideToXLoc(e,player.left+player.xvel+117*Math.sin(Math.PI*e.counter),.7*player.maxspeed))}function throwSpiny(e){if(!characterIsAlive(e))return!1;switchClass(e,"out","hiding"),TimeHandler.addEvent((function(e){if(e.dead)return!1;var t=new Thing(SpinyEgg);addThing(t,e.left,e.top),t.yvel=-2.1*unitsize,switchClass(e,"hiding","out")}),21,e)}function killLakitu(e){delete e.noscroll,killFlip(e)}function Spiny(e){e.width=e.height=8,e.group="enemy",e.speed=.21*unitsize,e.deadly=e.moveleft=!0,e.smart=!1,e.death=killFlip,e.collide=collideEnemy,e.movement=moveSimple,setCharacter(e,"spiny"),TimeHandler.addSpriteCycle(e,["one","two"])}function SpinyEgg(e){e.height=8,e.width=7,e.group="enemy",e.deadly=!0,e.movement=moveSpinyEgg,e.spawntype=Spiny,e.spawner=e.death=createSpiny,e.collide=collideEnemy,setCharacter(e,"spinyegg"),TimeHandler.addSpriteCycle(e,["one","two"])}function moveSpinyEgg(e){e.resting&&createSpiny(e)}function createSpiny(e){var t=new Thing(Spiny);addThing(t,e.left,e.top),t.moveleft=objectToLeft(player,t),killNormal(e)}function Beetle(e){e.width=e.height=8,e.group="enemy",e.speed=e.xvel=.21*unitsize,e.nofire=2,e.moveleft=!0,e.smart=!1,e.collide=collideEnemy,e.movement=moveSmart,e.death=killBeetle,setCharacter(e,"beetle"),TimeHandler.addSpriteCycleSynched(e,["one","two"])}function killBeetle(e,t){if(e.alive){var i;if(i=new Thing(t&&2!=t?Koopa:BeetleShell,e.smart),TimeHandler.addEvent((function(e,t){addThing(e,t.left,t.bottom-e.height*unitsize),e.moveleft=t.moveleft}),0,i,e),killNormal(e),2!=t)return i;killFlip(i)}}function BeetleShell(e){e.width=e.height=8,e.nofire=!0,e.group="item",e.speed=unitsizet2,e.moveleft=e.xvel=e.move=e.hitcount=e.peeking=e.counting=e.landing=e.enemyhitcount=0,e.movement=moveShell,e.collide=hitShell,e.death=killFlip,e.spawntype=Beetle,setCharacter(e,"shell beetle")}function Coin(e,t){e.group="coin",e.width=5,e.height=7,e.nofall=e.coin=e.nofire=e.nocollidechar=e.nokillend=e.onlyupsolids=e.skipoverlaps=!0,e.tolx=0,e.toly=unitsized2,e.collide=hitCoin,e.animate=coinEmerge,e.death=killNormal,setCharacter(e,"coin one"),TimeHandler.addSpriteCycleSynched(e,["one","two","three","two","one"]),t&&(e.movement=coinBecomesSolid)}function coinBecomesSolid(e){switchContainers(e,characters,solids),e.movement=!1}function hitCoin(e,t){e.player&&(AudioPlayer.play("Coin"),score(e,200,!1),gainCoin(),killNormal(t))}function gainCoin(){++data.coins.amount>=100&&(data.coins.amount=0,gainLife()),updateDataElement(data.coins)}function coinEmerge(e,t){AudioPlayer.play("Coin"),removeClass(e,"still"),switchContainers(e,characters,scenery),score(e,200,!1),gainCoin(),e.nocollide=e.alive=e.nofall=e.emerging=!0,e.blockparent?e.movement=coinEmergeMoveParent:e.movement=coinEmergeMove,e.yvel=-unitsize,TimeHandler.addEvent((function(e){e.yvel*=-1}),25,e),TimeHandler.addEvent((function(e){killNormal(e),deleteThing(e,scenery,scenery.indexOf(e))}),49,e),TimeHandler.addEventInterval(coinEmergeMovement,1,1/0,e,t),TimeHandler.clearClassCycle(e,0),addClass(e,"anim"),TimeHandler.addSpriteCycle(e,["anim1","anim2","anim3","anim4","anim3","anim2"],0,5)}function coinEmergeMovement(e,t){if(!e.alive)return!0;shiftVert(e,e.yvel)}function coinEmergeMove(e){shiftVert(e,e.yvel,!0)}function coinEmergeMoveParent(e){e.bottom>=e.blockparent.bottom?killNormal(e):shiftVert(e,e.yvel,!0)}function Player(e){setPlayerSizeSmall(e),e.walkspeed=unitsized2,e.canjump=e.nofiredeath=e.nofire=e.player=e.nokillend=1,e.numballs=e.moveleft=e.skidding=e.star=e.dying=e.nofall=e.maxvel=e.paddling=e.jumpers=e.landing=0,e.running="",e.power=data.playerpower,e.maxspeed=e.maxspeedsave=1.35*unitsize,e.scrollspeed=1.75*unitsize,e.keys=new Keys,e.fire=playerFires,e.movement=movePlayer,e.death=killPlayer,setCharacter(e,"player normal small still"),e.tolx=unitsizet2,e.toly=0,e.gravity=map.gravity,map.underwater&&(e.swimming=!0,TimeHandler.addSpriteCycle(e,["swim1","swim2"],"swimming",5))}function placePlayer(e,t){clearOldPlayer(),window.player=new Thing(Player),window.luigi?window.player.title="Luigi":window.player.title="Mario";var i=addThing(player,e||unitsizet16,t||(map.floor-player.height)*unitsize);return data.playerpower>=2&&(playerGetsBig(player,!0),3==data.playerpower&&playerGetsFire(player,!0)),i}function clearOldPlayer(){window.player&&(player.alive=!1,player.dead=!0)}function Keys(){this.run=this.crouch=this.jump=this.jumplev=this.sprint=0}function thingStoreVelocity(e,t){e.xvelOld=e.xvel||0,e.yvelOld=e.yvel||0,e.nofallOld=e.nofall||!1,e.nocollideOld=e.nocollide||!1,e.movementOld=e.movement||e.movementOld,e.nofall=e.nocollide=!0,e.xvel=e.yvel=!1,t||(e.movement=!1)}function thingRetrieveVelocity(e,t){t||(e.xvel=e.xvelOld||0,e.yvel=e.yvelOld||0),e.movement=e.movementOld||e.movement,e.nofall=e.nofallOld||!1,e.nocollide=e.nocollideOld||!1}function removeCrouch(){player.crouching=!1,player.toly=player.tolyold||0,1!=player.power&&(removeClass(player,"crouching"),player.height=16,updateBottom(player,0),updateSize(player))}function playerShroom(e){e.shrooming||(AudioPlayer.play("Powerup"),score(e,1e3,!0),3!=e.power&&(e.shrooming=!0,(2==++e.power?playerGetsBig:playerGetsFire)(e),storePlayerStats()))}function playerGetsBig(e,t){if(setPlayerSizeLarge(e),e.keys.down=0,removeClasses(player,"crouching small"),updateBottom(e,0),updateSize(e),t)addClass(e,"large");else{addClass(player,"shrooming");for(var i=[1,2,1,2,3,2,3],n=i.length-1;n>=0;--n)i[n]="shrooming"+i[n];thingStoreVelocity(player),i.push((function(e,t){return e.shrooming=t.length=0,addClass(e,"large"),removeClasses(e,"shrooming shrooming3"),thingRetrieveVelocity(player),!0})),TimeHandler.addSpriteCycle(e,i,"shrooming",6)}}function playerGetsSmall(e){var t=player.bottom;e.keys.down=0,thingStoreVelocity(e),addClass(e,"small"),flicker(e),removeClasses(player,"running skidding jumping fiery"),addClass(player,"paddling"),TimeHandler.addEvent((function(e){removeClass(e,"large"),setPlayerSizeSmall(e),setBottom(e,t-unitsize)}),21,player),TimeHandler.addEvent((function(e){thingRetrieveVelocity(e,!1),e.nocollidechar=!0,removeClass(e,"paddling"),(e.running||e.xvel)&&addClass(e,"running"),TimeHandler.addEvent(setThingSprite,1,e)}),42,player),TimeHandler.addEvent((function(e){e.nocollidechar=!1}),70,player)}function playerGetsFire(e){removeClass(e,"intofiery"),addClass(e,"fiery"),player.shrooming=!1}function setPlayerSizeSmall(e){setSize(e,8,8,!0),updateSize(e)}function setPlayerSizeLarge(e){setSize(e,8,16,!0),updateSize(e)}function movePlayer(e){if(e.keys.up){if(e.keys.jump>0&&(e.yvel<=0||map.underwater)&&(map.underwater&&playerPaddles(e),e.resting?(e.resting.xvel&&(e.xvel+=e.resting.xvel),e.resting=!1):(e.jumping||map.underwater||switchClass(e,"running skidding","jumping"),e.jumping=!0),!map.underwater)){var t=unitsize/pow(++e.keys.jumplev,map.jumpmod-.0014*e.xvel);e.yvel=max(e.yvel-t,map.maxyvelinv)}}else e.keys.jump=0;e.keys.crouch&&!e.crouching&&e.resting&&(1!=e.power&&(e.crouching=!0,addClass(e,"crouching"),e.height=11,e.tolyold=e.toly,e.toly=unitsizet4,updateBottom(e,0),updateSize(e)),e.resting.actionTop&&e.resting.actionTop(e,e.resting,e.resting.transport));var i=0;if(0==e.keys.run||e.crouching)e.xvel*=.98,i=.035;else{var n=e.keys.run*(.098*((e.keys.sprint&&!map.underwater||0)+1));e.xvel+=n||0,e.xvel*=.98,i=7e-4,signBool(e.keys.run)==e.moveleft?e.skidding||(addClass(e,"skidding"),e.skidding=!0):e.skidding&&(removeClass(e,"skidding"),e.skidding=!1)}e.xvel>i?e.xvel-=i:e.xvel<-i?e.xvel+=i:0!=e.xvel&&(e.xvel=0,window.nokeys||0!=e.keys.run||(e.keys.left_down?e.keys.run=-1:e.keys.right_down&&(e.keys.run=1))),Math.abs(e.xvel)<.14?e.running&&(e.running=!1,1==player.power&&setPlayerSizeSmall(e),removeClasses(e,"running skidding one two three"),addClass(e,"still"),TimeHandler.clearClassCycle(e,"running")):e.running||(e.running=!0,switchClass(e,"still","running"),playerStartRunningCycle(e),1==e.power&&setPlayerSizeSmall(e)),e.xvel>0?(e.xvel=min(e.xvel,e.maxspeed),e.moveleft&&(e.resting||map.underwater)&&(unflipHoriz(e),e.moveleft=!1)):e.xvel<0&&(e.xvel=max(e.xvel,-1*e.maxspeed),e.moveleft||!e.resting&&!map.underwater||(flipHoriz(e),e.moveleft=!0)),e.resting&&(e.hopping&&(removeClass(e,"hopping"),e.xvel&&addClass(e,"running"),e.hopping=!1),e.keys.jumplev=e.yvel=e.jumpcount=0,e.jumping&&(e.jumping=!1,removeClass(e,"jumping"),1==e.power&&setPlayerSizeSmall(e),addClass(e,abs(e.xvel)<.14?"still":"running")),e.paddling&&(e.paddling=e.swimming=!1,removeClasses(e,"paddling swim1 swim2"),TimeHandler.clearClassCycle(e,"paddling"),addClass(e,"running"))),isNaN(e.xvel)}function playerStartRunningCycle(e){e.running=TimeHandler.addSpriteCycle(e,["one","two","three","two"],"running",setPlayerRunningCycler)}function setPlayerRunningCycler(e){e.timeout=5+ceil(player.maxspeedsave-abs(player.xvel))}function playerPaddles(e){e.paddling||(removeClasses(e,"skidding paddle1 paddle2 paddle3 paddle4 paddle5"),addClass(e,"paddling"),TimeHandler.clearClassCycle(e,"paddling_cycle"),TimeHandler.addSpriteCycle(e,["paddle1","paddle2","paddle3","paddle3","paddle2","paddle1",function(){return e.paddling=!1}],"paddling_cycle",5)),e.paddling=e.swimming=!0,e.yvel=-.84*unitsize}function playerBubbles(){addThing(new Thing(Bubble),player.right,player.top)}function movePlayerVine(e){var t=e.attached;if(e.bottom<t.top)return unattachPlayer(e);if(e.keys.run==e.attachoff){for(;objectsTouch(e,t);)shiftHoriz(e,e.keys.run,!0);return unattachPlayer(e)}if(e.keys.up)e.animatednow=!0,shiftVert(e,-1*unitsized4,!0);else if(e.keys.crouch){if(e.animatednow=!0,shiftVert(e,unitsized2,!0),e.bottom>t.bottom-unitsizet4)return unattachPlayer(e)}else e.animatednow=!1;e.animatednow&&!e.animated?addClass(e,"animated"):!e.animatednow&&e.animated&&removeClass(e,"animated"),e.animated=e.animatednow,e.bottom<-16&&(locMovePreparations(e),!t.locnum&&map.random?goToTransport(["Random","Sky","Vine"]):shiftToLocation(t.locnum))}function unattachPlayer(e){e.movement=movePlayer,removeClasses(e,"climbing","animated"),TimeHandler.clearClassCycle(e,"climbing"),e.yvel=e.skipoverlaps=e.attachoff=e.nofall=e.climbing=e.attached=e.attached.attached=!1,e.xvel=e.keys.run}function playerHopsOff(e,t,i){removeClasses(e,"climbing running"),addClass(e,"jumping"),e.piping=e.nocollide=e.nofall=e.climbing=!1,e.gravity=gravity/4,e.xvel=3.5,e.yvel=-3.5,TimeHandler.addEvent((function(e){unflipHoriz(e),e.gravity=gravity,e.movement=movePlayer,e.attached=!1,i&&(addClass(e,"running"),playerStartRunningCycle(e))}),21,e)}function playerFires(){if(!(player.numballs>=2)){++player.numballs,addClass(player,"firing");var e=new Thing(FireBall,player.moveleft,!0);e.yvel=unitsize,addThing(e,player.right+unitsized4,player.top+unitsizet8),player.moveleft&&setRight(e,player.left-unitsized4,!0),e.animate(e),e.ondelete=fireDeleted,TimeHandler.addEvent((function(e){removeClass(e,"firing")}),7,player)}}function emergeFire(e){AudioPlayer.play("Fireball")}function playerStar(e){e.star||(++e.star,AudioPlayer.play("Powerup"),AudioPlayer.playTheme("Star",!0),TimeHandler.addEvent(playerRemoveStar,560,e),switchClass(e,"normal","star"),TimeHandler.addSpriteCycle(e,["star1","star2","star3","star4"],"star",5))}function playerRemoveStar(e){e.star&&(--e.star,removeClasses(e,"star star1 star2 star3 star4"),TimeHandler.clearClassCycle(e,"star"),addClass(e,"normal"),AudioPlayer.playTheme())}function killPlayer(e,t){if(e.alive&&!e.flickering&&!e.dying){if(2==t)notime=!0,e.dead=e.dying=!0;else{if(!t&&e.power>1)return AudioPlayer.play("Power Down"),e.power=1,storePlayerStats(),playerGetsSmall(e);2!=t&&(TimeHandler.clearAllCycles(e),setSize(e,7.5,7,!0),updateSize(e),setClass(e,"character player dead"),nokeys=notime=e.dying=!0,thingStoreVelocity(e),containerForefront(e,characters),TimeHandler.addEvent((function(e){thingRetrieveVelocity(e,!0),e.nocollide=!0,e.movement=e.resting=!1,e.gravity=gravity/2.1,e.yvel=-1.4*unitsize}),7,e))}AudioPlayer.pause(),window.editing||AudioPlayer.play("Player Dies"),e.nocollide=e.nomove=nokeys=1,--data.lives.amount,map.random||(data.score.amount=data.scoreold),window.editing?setTimeout((function(){editorSubmitGameFuncPlay(),editor.playing=editor.playediting=!0}),35*timer):!map.random||data.lives.amount<=0?window.reset=setTimeout(data.lives.amount?setMap:gameOver,280*timer):(nokeys=notime=!1,updateDataElement(data.score),updateDataElement(data.lives),TimeHandler.addEvent((function(){playerDropsIn(),AudioPlayer.playTheme()}),117))}}function playerDropsIn(){clearOldPlayer(),placePlayer(unitsizet16,-1*unitsizet8+map.underwater*unitsize*24),flicker(player),map.underwater?player.gravity=gravity/2.8:(player.nocollide=!0,TimeHandler.addEvent((function(){player.nocollide=!1,addThing(new Thing(RestingStone),player.left,player.bottom+player.yvel)}),map.respawndist||17))}function gameOver(){gameon=!1,pause(),AudioPlayer.pauseTheme(),AudioPlayer.play("Game Over");var e="<div style='font-size:49px;padding-top: "+(innerHeight/2-28)+"px'>GAME OVER</div>";e+="</p>",body.className="Night",body.innerHTML=e,window.gamecount=1/0,clearPlayerStats(),setTimeout(gameRestart,7e3)}function gameRestart(){seedlast=.007,body.style.visibility="hidden",body.innerHTML=body.style.paddingTop=body.style.fontSize="",body.appendChild(canvas),gameon=!0,map.random?setMapRandom():setMap(1,1),TimeHandler.addEvent((function(){body.style.visibility=""})),setLives(3)}function Floor(e,t,i){e.width=8*(t||1),e.height=8*i||unitsizet32,e.spritewidth=8,e.spriteheight=8,e.repeat=!0,setSolid(e,"floor")}function Clouds(e,t){e.width=8*t,e.height=8,setSolid(e,"clouds")}function Brick(e,t){if(e.width=e.height=8,e.used=!1,e.bottomBump=brickBump,t)if(t instanceof Array)for(e.contents=t;e.contents.length<3;)e.contents.push(!1);else e.contents=[t,!1,!1];else e.contents=!1;e.death=killNormal,setSolid(e,"brick unused"),e.tolx=1}function brickBump(e,t){if(!e.up&&"player"==t.type&&(AudioPlayer.play("Bump"),!e.used)){if(e.up=t,t.power>1&&!e.contents)return TimeHandler.addEvent(brickBreak,2,e,t);blockBumpMovement(e),e.contents&&(player.power>1&&e.contents[0]==Mushroom&&!e.contents[1]&&(e.contents[0]=FireFlower),TimeHandler.addEvent((function(e){var t=e.contents,i=new Thing(t[0],t[1],t[2]);addThing(i,e.left,e.top),setMidXObj(i,e,!0),i.blockparent=e,i.animate(i,e),e.contents[0]==Coin?(e.lastcoin&&makeUsedBlock(e),TimeHandler.addEvent((function(e){e.lastcoin=!0}),245,e)):makeUsedBlock(e)}),7,e))}}function makeUsedBlock(e){e.used=!0,switchClass(e,"unused","used")}function brickBreak(e,t){AudioPlayer.play("Break Block"),score(e,50),e.up=t,TimeHandler.addEvent(placeShards,1,e),killNormal(e)}function placeShards(e){for(var t,i=0;i<4;++i)addThing(t=new Thing(BrickShard),e.left+(i<2)*e.width*unitsize-unitsizet2,e.top+i%2*e.height*unitsize-unitsizet2),t.xvel=unitsized2-unitsize*(i>1),t.yvel=-1.4*unitsize+i%2,TimeHandler.addEvent(killNormal,350,t)}function BrickShard(e){e.width=e.height=4,e.nocollide=!0,e.death=killNormal,setCharacter(e,"brickshard"),TimeHandler.addSpriteCycle(e,[unflipHoriz,flipHoriz])}function attachEmerge(e,t){e.animate=setInterval((function(){setBottom(e,t.top,!0),t.up||(clearInterval(e.animate),e.animate=!1)}),timer)}function Block(e,t,i){if(e.width=e.height=8,e.used=!1,e.bottomBump=blockBump,t)if(t instanceof Array)for(e.contents=t;e.contents.length<3;)e.contents.push(!1);else e.contents=[t,!1,!1];else e.contents=[Coin];e.death=killNormal,setSolid(e,"Block unused"),e.hidden=!!i&&(e.hidden=e.skipoverlaps=!0),e.tolx=1,TimeHandler.addSpriteCycleSynched(e,["one","two","three","two","one"])}function blockBump(e,t){"player"==t.type&&(e.used?AudioPlayer.play("Bump"):(e.used=1,e.hidden=e.hidden=e.skipoverlaps=!1,e.up=t,blockBumpMovement(e),removeClass(e,"hidden"),switchClass(e,"unused","used"),player.power>1&&e.contents[0]==Mushroom&&!e.contents[1]&&(e.contents[0]=FireFlower),TimeHandler.addEvent(blockContentsEmerge,7,e)))}function blockContentsEmerge(e){var t=new Thing(e.contents[0],e.contents[1],e.contents[2]);addThing(t,e.left,e.top),setMidXObj(t,e,!0),t.blockparent=e,t.animate(t,e)}function Pipe(e,t,i){e.width=e.spritewidth=16,e.height=8*(t||1),!1!==i&&(e.actionTop=intoPipeVert,e.transport=i),setSolid(e,"pipe")}function PipeSide(e,t,i){e.width=e.spritewidth=i?8:19.5,e.height=e.spriteheight=16,t&&(e.actionLeft=intoPipeHoriz,e.transport=t),setSolid(e,"pipe side "+(i?"small":""))}function PipeVertical(e,t){e.spritewidth=e.width=16,e.spriteheight=e.repeat=1,e.height=t,setSolid(e,"pipe vertical")}function Vine(e,t){e.width=e.spriteheight=7,e.height=0,e.locnum=t,e.nocollide=e.nofall=e.repeat=!0,e.animate=vineEmerge,e.movement=vineMovement,setCharacter(e,"vine")}function vineEmerge(e,t){AudioPlayer.play("Vine Emerging"),setHeight(e,0),e.movement=vineMovement,TimeHandler.addEvent(vineEnable,14,e),TimeHandler.addEventInterval(vineStay,1,14,e,t)}function vineStay(e,t){setBottom(e,t.top)}function vineEnable(e){e.nocollide=!1,e.collide=touchVine}function vineMovement(e){increaseHeightTop(e,unitsized4),e.attached&&shiftVert(e.attached,-unitsized4,!0)}function touchVine(e,t){!e.player||e.attached||e.climbing||e.bottom>t.bottom+unitsizet2||(t.attached=e,e.attached=t,e.nofall=e.skipoverlaps=!0,e.xvel=e.yvel=e.resting=e.jumping=e.jumpcount=e.running=0,e.attachleft=!objectToLeft(e,t),e.attachoff=2*e.attachleft-1,e.movementsave=e.movement,e.movement=movePlayerVine,e.keys=new Keys,TimeHandler.clearClassCycle(e,"running"),removeClass(e,"running skidding"),unflipHoriz(e),e.attachleft&&flipHoriz(e),addClass(e,"climbing"),e.climbing=TimeHandler.addSpriteCycle(e,["one","two"],"climbing"),lookTowardThing(e,t),e.attachleft?setLeft(e,t.right-unitsizet4):setRight(e,t.left+unitsizet4))}function Springboard(e){e.width=8,e.height=e.heightnorm=14.5,e.tension=e.tensionsave=0,e.dir=1,e.collide=collideSpring,setSolid(e,"springboard")}function collideSpring(e,t){return e.yvel>=0&&e.player&&!t.tension&&characterOnSolid(e,t)?springPlayerInit(t,e):characterTouchedSolid(e,t)}function springPlayerInit(e,t){e.tension=e.tensionsave=max(.77*t.yvel,unitsize),t.movement=movePlayerSpringDown,t.spring=e,t.xvel/=2.8}function movePlayerSpringDown(e){return objectsTouch(e,e.spring)?e.spring.height<2.5*unitsize||e.spring.tension<unitsized32?(e.movement=movePlayerSpringUp,void(e.spring.movement=moveSpringUp)):((e.left<e.spring.left+unitsizet2||e.right>e.spring.right-unitsizet2)&&(e.xvel/=1.4),reduceSpringHeight(e.spring,e.spring.tension),setBottom(e,e.spring.top,!0),e.spring.tension/=2,void updateSize(e.spring)):(e.movement=movePlayer,e.spring.movement=moveSpringUp,void(e.spring=!1))}function movePlayerSpringUp(e){if(!e.spring||!objectsTouch(e,e.spring))return e.spring=!1,void(e.movement=movePlayer)}function moveSpringUp(e){reduceSpringHeight(e,-e.tension),e.tension*=2,e==player.spring&&setBottom(player,e.top,!0),e.height>e.heightnorm&&(e==player.spring&&(player.yvel=max(-unitsizet2,-.98*e.tensionsave),player.resting=player.spring=!1),reduceSpringHeight(e,(e.height-e.heightnorm)*unitsize),e.tension=e.tensionsave=e.movement=!1)}function reduceSpringHeight(e,t){reduceHeight(e,t,!0)}function Stone(e,t,i){e.width=8*t||8,e.height=8*i||8,e.repeat=!0,setSolid(e,"Stone")}function GenericStone(e,t,i){return Stone(e,t,i)}function RestingStone(e){e.width=e.height=8,e.used=!1,e.movement=RestingStoneUnused,setSolid(e,"Stone hidden"),e.title="Stone"}function RestingStoneUnused(e){if(player.resting){if(player.resting!=e)return killNormal(e);e.movement=RestingStoneUsed,removeClass(e,"hidden"),setThingSprite(player)}}function RestingStoneUsed(e){if(!player.resting)return killNormal(e)}function CastleBlock(e,t,i){e.width=e.height=8;var n,l,o=!1;t instanceof Array?(n=t[0],l=t[1],o=i):(n=t,l=i),setSolid(e,o?"castleblockinvis":"castleblock"),n&&(e.balls=new Array(n),e.dt=.07*(l?1:-1),e.timeout=round(7/(abs(l)||1)),e.movement=castleBlockSpawn,e.timer=e.counter=0,e.angle=.25,e.spawn_as_char=!0)}function castleBlockSpawn(e){for(var t=0;t<e.balls.length;++t){spawn=new Thing(CastleFireBall,4*t);var i=e.width*unitsized4,n=e.left+i,l=e.top+i;e.balls[t]=addThing(spawn,n+t*unitsize*3,l+t*unitsize*3)}e.movement=!1;abs(e.dt);TimeHandler.addEventInterval(castleBlockEvent,e.timeout,1/0,e)}function castleBlockEvent(e){e.midx=e.left,e.midy=e.top,e.counter=0,e.angle+=e.dt;for(var t=1;t<e.balls.length;++t)setMidX(e.balls[t],e.midx+t*unitsizet4*Math.cos(e.angle*Math.PI),!0),setMidY(e.balls[t],e.midy+t*unitsizet4*Math.sin(e.angle*Math.PI),!0)}function CastleFireBall(e,t){e.width=e.height=4,e.deadly=e.nofire=e.nocollidechar=e.nocollidesolid=e.nofall=e.nostar=e.outerok=e.skipoverlaps=!0,e.movement=!1,e.collide=collideEnemy,setCharacter(e,"fireball castle"),TimeHandler.addSpriteCycle(e,["one","two","three","four"],4)}function CastleBridge(e,t){e.height=8,e.width=8*t||4,e.spritewidth=4,e.repeat=!0,setSolid(e,"CastleBridge")}function CastleChain(e){e.height=8,e.width=e.spritewidth=7.5,e.nocollide=!0,setSolid(e,"castlechain")}function CastleAxe(e){e.width=e.height=8,e.spritewidth=e.spriteheight=8,e.nocollide=!0,setSolid(e,"castleaxe"),TimeHandler.addSpriteCycle(e,["one","two","three","two"])}function CastleAxeFalls(e,t){var i=t.axe;!e.player||e.right<i.left+unitsize||e.bottom>i.bottom-unitsize||(killNormal(i),killNormal(t),notime=nokeys=!0,thingStoreVelocity(e),killOtherCharacters(),TimeHandler.addEvent(killNormal,7,i.chain),TimeHandler.addEvent(CastleAxeKillsBridge,14,i.bridge,i),AudioPlayer.pauseTheme(),AudioPlayer.playTheme("World Clear",!1,!1))}function CastleAxeKillsBridge(e,t){e.width-=2,e.right-=unitsizet2,e.width>0?TimeHandler.addEvent(CastleAxeKillsBridge,1,e,t):(e.width=0,TimeHandler.addEvent(CastleAxeKillsBowser,1,t.bowser)),setWidth(e,e.width)}function CastleAxeKillsBowser(e){e.nofall=!1,e.nothrow=!0,++player.star,TimeHandler.addEvent(CastleAxeContinues,35,player)}function CastleAxeContinues(e){map.canscroll=!0,startWalking(e)}function Toad(e){e.width=16,e.height=e.spriteheight=12,e.group="toad",setSolid(e,"toad npc")}function Peach(e){e.width=16,e.height=e.spriteheight=12,e.group="peach",setSolid(e,"peach npc")}function collideCastleNPC(e,t){killNormal(t),e.keys.run=0,TimeHandler.addEvent((function(e){var t;for(t=0;t<e.length;++t)TimeHandler.addEvent(proliferate,70*t,e[t].element,{style:{visibility:"visible"}});TimeHandler.addEvent(endLevel,70*(t+3))}),21,t.text)}function TreeTop(e,t){e.width=8*t,e.height=8,e.repeat=!0,setSolid(e,"treetop")}function ShroomTop(e,t){e.width=8*t,e.height=8,e.repeat=!0,setSolid(e,"shroomtop")}function Platform(e,t,i){e.width=4*(t||4),e.height=4,e.spritewidth=4,e.moving=0,e.repeat=e.killonend=!0,"function"==typeof i&&(i=[i]),i instanceof Array&&(e.movement=i[0],e.begin=i[1]*unitsize,e.end=i[2]*unitsize,e.maxvel=(i[3]||1.5)*unitsized4,e.movement==moveFloating||e.movement==movePlatformSpawn?e.yvel=e.maxvel:e.xvel=e.maxvel,e.changing=0),e.movement==collideTransport&&(e.movement=!1,e.collide=collideTransport),setSolid(e,"platform")}function PlatformGenerator(e,t,i){e.width=4*t,e.interval=35,e.height=6*e.interval,e.dir=i,e.nocollide=e.hidden=!0,e.movement=PlatformGeneratorInit,setSolid(e,"platformgenerator")}function PlatformGeneratorInit(e){for(var t=0,i=e.interval,n=e.height;t<n;t+=i)e.platlast=new Thing(Platform,e.width/4,[movePlatformSpawn,0,0,1.5]),e.platlast.yvel*=e.dir,1==e.dir?addThing(e.platlast,e.left,e.top+t*unitsize):addThing(e.platlast,e.left,e.bottom-t*unitsize),e.platlast.parent=e,t+=e.interval;e.movement=!1}function movePlatformSpawn(e){e.bottom<e.parent.top?(setBottom(e,e.parent.bottom),detachPlayer(e)):e.top>e.parent.bottom?(setTop(e,e.parent.top),detachPlayer(e)):movePlatformNorm(e)}function movePlatformNorm(e){shiftHoriz(e,e.xvel),shiftVert(e,e.yvel),e==player.resting&&e.alive&&(setBottom(player,e.top),shiftHoriz(player,e.xvel),player.right>innerWidth&&setRight(player,innerWidth))}function detachPlayer(e){player.resting==e&&(player.resting=!1)}function Scale(e,t,i){e.height=5,e.width=4*t,e.spritewidth=e.spriteheight=5,e.repeat=e.nocollide=!0,setSolid(e,"scale")}function Flag(e){e.width=e.height=8,e.nocollide=!0,setSolid(e,"flag")}function FlagPole(e){e.width=1,e.height=72,e.nocollide=e.repeat=!0,setSolid(e,"flagpole")}function FlagTop(e){e.spritewidth=e.spriteheight=e.width=e.height=4,e.nocollide=!0,setSolid(e,"flagtop")}function FlagDetector(e){e.width=2,e.height=100,e.collide=FlagCollision,setSolid(e,"flagdetector"),e.hidden=!0}function CastleDoorDetector(e){e.width=e.height=4,e.collide=endLevelPoints,setSolid(e,"castledoor"),e.hidden=!0}function FlagCollision(e,t){if(!e||!e.player)return killNormal(e);window.detector=t,AudioPlayer.pause(),AudioPlayer.play("Flagpole"),killOtherCharacters(),nokeys=notime=player.nofall=1,player.xvel=player.yvel=player.keys.up=player.keys.jump=map.canscroll=map.ending=player.movement=0,player.nocollidechar=!0,setRight(e,t.pole.left,!0),removeClasses(e,"running jumping skidding"),addClass(e,"climbing animated"),updateSize(e),TimeHandler.addSpriteCycle(e,["one","two"],"climbing"),playerRemoveStar(player);var i=!1,n=!1,l=(t.stone.top-e.bottom)/unitsize,o=setInterval((function(){i||(e.bottom>=t.stone.top?(scorePlayerFlag(l,t.stone),i=!0,setBottom(e,t.stone.top,!0),removeClass(player,"animated"),TimeHandler.clearClassCycle(player,"climbing")):shiftVert(e,unitsize,!0)),n||(t.flag.bottom>=t.stone.top?(n=!0,setBottom(t.flag,t.stone.top,!0)):shiftVert(t.flag,unitsize,!0)),i&&n&&(setBottom(e,t.stone.top,!0),clearInterval(o),setTimeout((function(){FlagOff(e,t.pole)}),21*timer)),refillCanvas()}),timer)}function scorePlayerFlag(e,t){var i;i=e<28?e<8?100:400:e<40?800:e<62?2e3:5e3,score(player,i,!0)}function FlagOff(e,t){player.keys.run=notime=nokeys=1,player.maxspeed=player.walkspeed,flipHoriz(e),TimeHandler.clearClassCycle(e,"climbing"),setLeft(e,t.right,!0),setTimeout((function(){AudioPlayer.play("Stage Clear"),playerHopsOff(e,t,!0)}),14*timer)}function endLevelPoints(e,t){if(e&&e.player){notime=nokeys=!0,killNormal(t),killNormal(e);var i=parseInt(getLast(String(data.time.amount)));1!=i&&3!=i&&6!=i&&(i=0);var n=setInterval((function(){--data.time.amount,data.score.amount+=50,updateDataElement(data.score),updateDataElement(data.time),AudioPlayer.play("Coin"),data.time.amount<=0&&(clearInterval(n),setTimeout((function(){endLevelFireworks(e,i,t)}),49*timer))}),timer)}}function endLevelFireworks(e,t,i){var n,l,o=0;if(t){for(var a=i.left+32*unitsized2;o<t;)explodeFirework(++o,a);n=timer*(o+2)*42}else n=0;l=function(){setTimeout((function(){endLevel()}),n)},AudioPlayer.addEventImmediate("Stage Clear","ended",(function(){TimeHandler.addEvent(l,35)}))}function explodeFirework(e,t){setTimeout((function(){var i=new Thing(Firework,e);addThing(i,t+i.locs[0]-6*unitsize,unitsizet16+i.locs[1]),i.animate()}),timer*e*42)}function Firework(e,t){if(e.width=e.height=8,e.nocollide=e.nofire=e.nofall=!0,t)switch(t){case 1:e.locs=[unitsizet16,unitsizet16];break;case 2:e.locs=[-unitsizet16,unitsizet16];break;case 3:e.locs=[2*unitsizet16,2*unitsizet16];break;case 4:e.locs=[-2*unitsizet16,2*unitsizet16];break;case 5:e.locs=[0,1.5*unitsizet16];break;default:e.locs=[0,0]}e.animate=function(){var t=e.className+" n";e.locs&&AudioPlayer.play("Firework"),TimeHandler.addEvent((function(e){setClass(e,t+1)}),0,e),TimeHandler.addEvent((function(e){setClass(e,t+2)}),7,e),TimeHandler.addEvent((function(e){setClass(e,t+3)}),14,e),TimeHandler.addEvent((function(e){killNormal(e)}),21,e)},setCharacter(e,"firework"),score(e,500)}function Coral(e,t){e.width=8,e.height=8*t,e.repeat=!0,setSolid(e,"coral")}function BridgeBase(e,t){e.height=4,e.spritewidth=4,e.width=8*t,e.repeat=!0,setSolid(e,"bridge-base")}function WarpWorld(e){e.width=106,e.height=88,e.movement=setWarpWorldInit,e.collide=enableWarpWorldText,e.pirhanas=[],e.pipes=[],e.texts=[],e.hidden=!0,setSolid(e,"warpworld")}function setWarpWorldInit(e){shiftHoriz(e,e.width*unitsized2),e.width/=2,updateSize(e),e.movement=!1}function enableWarpWorldText(e,t){var i,n=t.pirhanas,l=t.texts;for(i in n)n[i].death();for(i in l)l[i].element.style.visibility="";killNormal(t)}function resetScenery(){window.Scenery={sprites:{BrickHalf:[8,4],BrickPlain:[8,8],Bush1:[16,8],Bush2:[24,8],Bush3:[32,8],Castle:[75,88],CastleDoor:[8,20],CastleRailing:[8,4],CastleRailingFilled:[8,4],CastleTop:[12,12],CastleWall:[8,48],Cloud1:[16,12],Cloud2:[24,12],Cloud3:[32,12],HillSmall:[24,9.5],HillLarge:[40,17.5],Fence:[8,8],Pirhana:[8,12],pirhana:[8,12],PlantSmall:[7,15],PlantLarge:[8,23],Railing:[4,4],ShroomTrunk:[8,8],String:[1,1],TreeTrunk:[8,8],Water:{0:4,1:5,spriteCycle:["one","two","three","four"]},WaterFill:[4,5]},patterns:{backreg:[["HillLarge",0,0],["Cloud1",68,68],["Bush3",92,0],["HillSmall",128,0],["Cloud1",156,76],["Bush1",188,0],["Cloud3",220,68],["Cloud2",292,76],["Bush2",332,0],["Blank",384]],backcloud:[["Cloud2",28,64],["Cloud1",76,32],["Cloud2",148,72],["Cloud1",228,0],["Cloud1",284,32],["Cloud1",308,40],["Cloud1",372,0],["Blank",384]],backcloudmin:[["Cloud1",68,68],["Cloud1",156,76],["Cloud3",220,68],["Cloud2",292,76],["Blank",384]],backfence:[["PlantSmall",88,0],["PlantLarge",104,0],["Fence",112,0,4],["Cloud1",148,68],["PlantLarge",168,0],["PlantSmall",184,0],["PlantSmall",192,0],["Cloud1",220,76],["Cloud2",244,68],["Fence",304,0,2],["PlantSmall",320,0],["Fence",328,0],["PlantLarge",344,0],["Cloud1",364,76],["Cloud2",388,68],["Blank",384]],backfencemin:[["PlantLarge",104,0],["Fence",112,0,4],["Cloud1",148,68],["PlantLarge",168,0],["PlantSmall",184,0],["PlantSmall",192,0],["Cloud1",220,76],["Cloud2",244,68],["Fence",304,0,2],["PlantSmall",320,0],["Fence",328,0],["Cloud1",364,76],["Cloud2",388,68],["Blank",384]],backfencemin2:[["Cloud2",4,68],["PlantSmall",88,0],["PlantLarge",104,0],["Fence",112,0,1],["Fence",128,0,2],["Cloud1",148,68],["PlantSmall",184,0],["PlantSmall",192,0],["Cloud1",220,76],["Cloud2",244,68],["Fence",304,0,2],["PlantSmall",320,0],["Fence",328,0],["PlantLarge",344,0],["Cloud1",364,76],["Cloud2",388,68],["Blank",384]],backfencemin3:[["Cloud2",4,68],["PlantSmall",88,0],["PlantLarge",104,0],["Fence",112,0,4],["Cloud1",148,68],["PlantSmall",184,0],["PlantSmall",192,0],["Cloud1",220,76],["Cloud2",244,68],["Cloud1",364,76],["Cloud2",388,68],["Blank",384]]}},processSceneryPatterns(Scenery.patterns)}function processSceneryPatterns(e){var t,i;for(i in e)(t=e[i]).length&&(t.width=t[t.length-1][1],t.pop())}function SceneryBlocker(e,t,i){e.width=t||8,e.height=i||8,e.nocollide=e.hidden=!0,setSolid(e,"sceneryblocker")}function Sprite(e,t,i){i||(i=[1,1]);var n=e.template=Scenery.sprites[t];n?(e.width=(e.spritewidth=n[0])*(i[0]||1),e.height=(e.spriteheight=n[1])*(i[1]||1),e.unitwidth=e.spritewidth*unitsize,e.unitheight=e.spriteheight*unitsize,e.nocollide=e.maxquads=1,e.repeat=!0,setScenery(e,"scenery "+t),e.title=t,n.spriteCycleTimer&&TimeHandler.addSpriteCycle(e,spriteCycleTimer,spriteCycleTimer||void 0)):log("No sprite template found for",t)}function LocationShifter(e,t,i){e.loc=t,e.width=i[0],e.height=i[1],e.collide=collideLocationShifter,e.hidden=!0,setSolid(e,"blue")}function collideLocationShifter(e,t){e.player&&(t.nocollide=player.piping=!0,TimeHandler.addEvent((function(e){shiftToLocation(t.loc),map.random&&entryRandom(e)}),1,e))}function ScrollBlocker(e,t){e.width=40,e.height=140,e.nocollide=e.hidden=!0,e.big=t,e.movement=function(){e.left-player.xvel<=gamescreen.right-gamescreen.left&&(map.canscroll=e.movement=!1,map.noscroll=e.big)},setSolid(e,"scrollblocker")}function ScrollEnabler(e){e.width=40,e.height=140,e.hidden=!0,e.collide=function(){e.left-player.xvel<=gamescreen.right-gamescreen.left&&(map.canscroll=e.nocollide=!0)},setSolid(e,"scrollenabler")}function zoneToggler(e,t){e.width=40,e.height=140,e.func=t,e.hidden=!0,e.collide=function(e,t){t.func(),t.nocollide=!0},setSolid(e,"zonetoggler "+t.name)}function GenerationStarter(e,t,i){e.width=8,e.height=gamescreen.height+20,e.func=t,e.arg=i,e.collide=function(e,t){if("player"!=e.type)return!1;spawnMap(),killNormal(t)},e.movement=function(e){e.movement=!1,addClass(e,"used"),e.func((gamescreen.left+e.right)/unitsize,e.arg)},setSolid(e,"generationstarter"),e.hidden=!0}function castleDecider(e,t,i){e.height=ceilmax,e.width=10,e.nocollide=!0,e.xloc=t,e.section=map.area.sections[i],e.next=map.area.sections[i+1],e.movement=function(e){if(!(e.left>gamescreen.right-gamescreen.left)&&e.section.activated){var t=e.section;t.numpass=t.colliders.length=0,t.passed?(++map.area.sections.current,e.next(e.xloc)):t(e.xloc),t.activated=t.passed=!1,spawnMap(),killNormal(e)}},setSolid(e,"decider blue "+i),e.hidden=!0}function FuncCollider(e,t,i){i?(e.width=i[0],e.height=i[1]):(e.width=8,e.height=ceilmax+40),e.collide=t,e.hidden=!0,setSolid(e,"funccollider blue "+t.name)}function FuncSpawner(e,t,i){e.width=8,e.height=8,e.movement=function(){t(e,i)},e.argument=i,e.nocollide=e.hidden=!0,setSolid(e,"funccollider blue "+t.name)}function Collider(e,t,i){e.width=t[0],e.height=t[1],i instanceof Array?(e.func=i[0]||function(){},e.movement=i[1]||function(){}):(e.func=i||function(){},e.movement=!1),e.collide=function(e,t){if(!e.player)return!1;t.func(e,t)},setSolid(e,"collider blue "+e.func.name),e.hidden=!0}