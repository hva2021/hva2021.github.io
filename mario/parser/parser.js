var num_files,dropzone,curlist,outlist,numdisplay,files,palette,palettes,palette_name,palette_names,palette_elem,palette_elems,scale_x=1,scale_y=1,digitsize=1,max=Math.max,min=Math.min,round=Math.round,abs=Math.abs;function load(){dropzone=document.getElementById("dropzone"),curlist=document.getElementById("curlist"),outlist=document.getElementById("outlist"),numdisplay=document.getElementById("num_files"),num_files=0,dropzone.onchange=handleInputChange,dropzone.ondragover=handleDragOver,dropzone.ondragleave=handleDragOff,dropzone.ondrop=handleFileSelect,initializePalettes()}function handleInputChange(e){dropzone.ondragleave(),e.target.ondragleave()}function handleFileSelect(e){preventAll(e),this.style.backgroundColor="";for(var t,a,n=window.files=e.dataTransfer.files,r=[],l=0;a=n[l];l++)"gif"==(t=a.type.split("/")[1])||"png"==t||"jpeg"==t||"jpg"==t?(++num_files,r.push("<li><strong>",a.name,"</strong> <grey>(",t,")</grey>"),outlist.appendChild(getWorkerElement(a))):r.push("<li>Only images are supported! <grey>("+t+")</grey></li>");dropzone.innerHTML=n.length+" file"+(1==n.length?"":"s")+" selected",curlist.innerHTML=r.join("")}function getWorkerElement(e){var t=getOutputListElement(e.name),a=new FileReader;return a.onprogress=updateProgress,a.element=t,a.onloadend=startWorking,a.readAsDataURL(e),t}function getOutputListElement(e){var t=document.createElement("li"),a=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div"),s=document.createElement("div");return t.name=e,t.statusbase=a.innerText="Uploading "+e+"...",t.status=a,t.progress=n,t.base64=r,t.results=l,t.close=s,t.appendChild(a),t.appendChild(n),t.appendChild(r),t.appendChild(l),t.appendChild(s),a.className="status",t.className="output",n.className="progress",r.className="base64",l.className="results",s.className="close",setTextDisplayer(r,"Base 64"),setTextDisplayer(l,"Sprite"),t}function updateProgress(e){if(e.lengthComputable){var t=round(e.loaded/e.total*100);t<=100&&(this.element.status.innerText=this.element.statusbase+" ("+t+"%)",this.element.progress.style.width=t+"%")}}function startWorking(e){var t=e.currentTarget,a=t.element,n=t.result;setTimeout((function(){a.status.innerText="Working on "+a.name+"...",a.progress.style.backgroundColor="rgb(117,175,245)"}),350),setDisplayerText(a.base64,n);var r=document.createElement("canvas"),l=r.getContext("2d"),s=document.createElement("image");s.src=n,s.onload=function(){r.width=s.width,r.height=s.height,l.drawImage(s,0,0);var e,t=l.getImageData(0,0,s.width,s.height);setTimeout((function(){a.status.innerHTML="<strong>"+a.name+"</strong><weak><grey style='text-shadow:none;'>("+palette_name+")</grey></weak>",a.status.style.color="white",a.progress.style.backgroundColor="rgb(35,35,70)",e=parseData(t.data,a,palette),setDisplayerText(a.results,e)}),350)}}function parseData(e,t){var a,n,r,l=[],s={},i=e.length;for(n=0,r=0;n<i;n+=4,++r)s[a=l[r]=getClosestPalette([e[n],e[n+1],e[n+2],e[n+3]])]?++s[a]:s[a]=1;return combineSimilarChars(l,getNewPaletteFromOccurences(s))}function combineSimilarChars(e,t){var a,n,r,l,s=t[0],i=t[1],o=max(3,round(4/i)),u="";for(a=0,r=e.length;a<r;++a){for(n=a+1,l=e[a];l==e[n];)++n;n-a>o?(u+="x"+makedigit(l,i,s)+String(n-a)+",",a=n-1):u+=makedigit(l,i,s)}return"p["+grabKeys(s)+"]"+u}function getNewPaletteFromOccurences(e){var t,a=[],n=0;for(t in e)a[t]=n,++n;return[a,getDigitSizeFromLength(n)]}function makedigit(e,t,a){return fillChars(max(0,t-String(e).length),"0")+a[e]}function fillChars(e,t){for(var a="";e--;)a+=t;return a}function grabKeys(e){var t,a=[];for(t in e)a.push(t);return a.join(",")}function getClosestPalette(e){var t,a,n,r=1/0;for(t=palette.length-1;t>=0;--t)(n=arrayDiff(e,palette[t]))<r&&(r=n,a=t);return a}function arrayDiff(e,t){var a,n=0;for(a=e.length-1;a>=0;--a)n+=abs(e[a]-t[a]);return n}function arrayEquals(e,t){return!(e<t||t<e)}function handleDragOver(e){preventAll(e),e.dataTransfer.dropEffect="copy",this.style.backgroundColor="lightgrey"}function handleDragOff(e){this.style.backgroundColor=""}function preventAll(e){e.stopPropagation(),e.preventDefault()}function setTextDisplayer(e,t){e.className+=" displayer";var a=e.title=document.createElement("div"),n=e.display=document.createElement("input");e.copyout=document.createElement("div");a.innerText=t+": ",a.className="title",n.className="display",e.appendChild(a),e.appendChild(n)}function setDisplayerText(e,t){e.display.value=t}function initializePalettes(){palettes=[[[0,0,0,0],[255,255,255,255],[0,0,0,255]],[[0,0,0,0],[255,255,255,255],[0,0,0,255],[199,199,192,255],[128,128,128,255]],[[0,0,0,0],[255,255,255,255],[0,0,0,255],[188,188,188,255],[116,116,116,255],[252,216,168,255],[252,152,56,255],[252,116,180,255],[216,40,0,255],[200,76,12,255],[136,112,0,255],[124,7,0,255],[168,250,188,255],[128,208,16,255],[0,168,0,255],[24,60,92,255],[0,128,136,255],[32,56,236,255],[156,252,240,255],[60,188,252,255],[92,148,252,255],[0,130,0,255]]],palette_names=["Black & White","GameBoy","Mario"];var e,t,a,n,r,l,s,i=document.getElementById("palettes");for(palette_elems=[],e=0,a=palettes.length;e<a;++e){for(n=palettes[e],palette_elems[e]=r=document.createElement("div"),r.innerHTML="<p class='palettename'>"+palette_names[e]+"</p>",t=0;t<n.length;++t)l=document.createElement("div"),s=document.createElement("div"),l.className="square",s.className="squarein",s.style.background=getColorFromArray(n[t]),l.appendChild(s),r.appendChild(l);r.palettenum=e,r.onclick=setCurrentPalette,r.className="squares",i.appendChild(r)}palette_elems[localStorage.palette_num||0].click()}function getColorFromArray(e){return"rgba("+e.join(", ")+")"}function setCurrentPalette(e){var t=this.palettenum;palette=palettes[t],palette_name=palette_names[t],digitsize=getDigitSize(palette),digitsize=palette.length>=10?2:1,palette_elem&&(palette_elem.className="squares"),palette_elem=this,this.className="squares selected",localStorage.palette_num=t}function getDigitSize(e){return Number(String(e.length).length)}function getDigitSizeFromLength(e){return Number(String(e).length)}function setScaleValue(e){window["scale_"+this.alpha]=Number(this.value)||1}function sum(e,t){return Number(e)+Number(t)}