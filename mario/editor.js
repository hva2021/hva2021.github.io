function loadEditor(e){editorClose(),e||(window.canedit=!0,setMap(["Special","Blank"]),window.canedit=!1),setEditorLibrary(),setEditorHTML(),setEditorControls(),setEditorTriggers(),setEditorLocalRetrieval(),classAdd(body,"editor"),classAdd(editor.sidebar,"expanded"),TimeHandler.addEvent(classRemove,35,editor.sidebar,"expanded"),map.shifting=!1,window.editing=!0}function setEditorLibrary(){window.editor={xloc:0,yloc:0,playing:!1,canplace:!0,offset:{x:unitsizet2},settings:{night:!1,setting:"Overworld",alt:!1},defaults:{width:8,height:8,widthoff:0,heightoff:0,minimum:1,followerUpdate:editorFollowerUpdateStandard,prefunc:pushPreThing,outerok:!0},placed:[],characters:{Goomba:{},Koopa:{height:12,arguments:{smart:Boolean,movement:["moveSimple","moveJumping","moveFloating"]},followerUpdate:function(e,t){var i="True"==t.smart,o=t.movement,r="moveJumping"==o;return"moveFloating"==o&&(r=[8,72]),[i,r]},onadds:{nocollide:!1}},Beetle:{width:8.5,height:8.5},HammerBro:{height:12},CheepCheep:{arguments:{smart:Boolean},attributes:{nofall:!0}},Lakitu:{height:12},Podoboo:{width:7},Blooper:{height:12,onadds:{nofall:!0}},Bowser:{width:16,height:16}},solids:{Floor:{arguments:{width:8},mydefaults:{width:8},prefunc_custom:function(e,t,i,o){var r="Floor, "+e.xloc+", "+e.yloc;return o[1]&&(r+=", "+o[1]),r}},Brick:{arguments:{contents:["false","Coins","Star"]},followerUpdate:function(e,t){var i=[];t.contents;return i.push(window[t.contents]),i},prefunc_custom:function(e,t,i,o){var r="Brick, ";return r+=e.xloc+", "+e.yloc+", ",r+=t.contents[0].name}},Block:{arguments:{contents:["Coin","Mushroom","Star","1Up Mushroom"],hidden:Boolean},followerUpdate:function(e,t){var i=[];return"1Up Mushroom"==t.contents?i.push([Mushroom,1]):i.push(window[t.contents]),"True"==t.hidden&&(TimeHandler.addEvent((function(){editor.follower.hidden=!0})),i.push(1)),i},prefunc_custom:function(e,t,i,o){var r="Block, ",n=t.contents,d=n[0].name;return r+=e.xloc+", "+e.yloc,"Coin"!=d?("Mushroom"==d&&n[1]?r+=", [Mushroom, "+String(n[1])+"]":r+=", "+d,t.hidden&&(r+=", true")):t.hidden&&(r+=", false, true"),r}},Cannon:{arguments:{height:8},sprite_source:"top"},Pipe:{width:16,prefunc:pushPrePipe,prefunc_solo:!0,arguments:{height:8,Pirhana:Boolean},followerUpdate:function(e,t){var i=[];return i.push(Number(t.height)),i.push(Boolean(t.Pirhana)),i},sprite_source:"top"},Stone:{arguments:{width:8,height:8},prefunc_custom:function(e,t,i,o){var r="Stone, "+e.xloc+", "+e.yloc;return r+=", "+o[1]+", "+o[2]}},Coral:{arguments:{height:8}},CastleBlock:{arguments:{fireballs:2,direction:["CW","CCW"],hidden:Boolean},followerUpdate:function(e,t){return[[Number(t.fireballs),"CW"==t.direction],"True"==t.hidden]}},Springboard:{height:14.5,heightoff:1.5}},scenery:{Bush1:{width:16},Bush2:{width:24},Bush3:{width:32},Cloud1:{width:16,height:12},Cloud2:{width:24,height:12},Cloud3:{width:32,height:12},HillSmall:{width:24,height:9.5,heightoff:-1.5},HillLarge:{width:40,height:17.5,heightoff:-1.5},PlantSmall:{width:7,height:15,heightoff:1},PlantLarge:{height:23,heightoff:1},Fence:{},Water:{width:4,height:4,prefunc:fillPreWater,prefunc_solo:!0,prefunc_custom:function(e,t,i,o){return e.xloc+", "+e.yloc}}}};var e,t,i,o;editor.defaults;for(i in editor)for(o in e=editor[i],editor[i])t=e[o],proliferate(t,editor.defaults,!0);for(i in e=editor.scenery)t=e[i],proliferate(t,{createfunc:function(e){return ThingCreate(Sprite,e.spritename)},spritename:i,prefunc_custom:function(e,t,i,o){return"'"+i.spritename+"', "+e.xloc+", "+(e.yloc-i.height)}},!0),t.prefunc==pushPreThing&&(t.prefunc=pushPreScenery)}function setEditorHTML(){createEditorGuideLines(),createEditorSidebar(),createEditorBottomBar(),createEditorScrollers(),editor.sectionselect.onchange()}function createEditorSidebar(){var e,t=["Solids","Characters","Scenery","Settings"],i=editor.sidebar=createElement("div",{id:"sidebar"}),o=editor.category=createElement("div",{id:"category",className:"group first"}),r=editor.sectionselect=createElement("select",{id:"sectionselect",className:"options big",onchange:editorSelectSection}),n=editor.options=createElement("div",{id:"options",className:"options big"});for(e in i.appendChild(o),o.appendChild(r),t)r.appendChild(createElement("option",{innerText:t[e]}));i.appendChild(n),body.appendChild(window.sidebar=i)}function createEditorBottomBar(){var e=editor.bottombar=createElement("div",{id:"bottombar",things:{}});sidebar.appendChild(e)}function createEditorScrollers(){var e,t,i,o=["right","left"],r={};for(t=createElement("div",{id:"scrollers",style:{zIndex:7,width:innerWidth-32+"px"}}),settings={className:"scroller",style:{zIndex:7,marginTop:innerHeight/2+"px"},onmouseover:editorFollowerHide,onmouseout:editorFollowerShow,onmousedown:editorScrollingStart,onmouseup:editorScrollingStop},e=o.length-1;e>=0;--e)o[e],i=r[o[e]]=createElement("div",settings),t.appendChild(i);proliferate(r.left,{id:"left",className:"scroller flipped off",dx:-7}),proliferate(r.right,{id:"right",style:{right:"21px"},dx:7}),editor.scrollers=r,body.appendChild(t)}function editorFollowerHide(){var e=editor.follower;e.hiddenOld=e.hidden,e.hidden=!0}function editorFollowerShow(){var e=editor.follower;e.hidden=e.hiddenOld}function editorScrollingStart(e){var t=e.target.dx;editorPreventClicks(),editor.scrolling=TimeHandler.addEventInterval(editorScrolling,1,1/0,-t),classRemove(editor.scrollers.left,"off")}function editorScrollingStop(){TimeHandler.addEvent(editorClickOff,3),TimeHandler.clearEvent(editor.scrolling)}function editorScrolling(e){if(scrollEditor(e),editor.xloc>=0)return scrollEditor(-editor.xloc),editorScrollingStop(),classAdd(editor.scrollers.left,"off"),!0}function createEditorGuideLines(){var e,t,i,o={floor:0,ceiling:ceillev,jumplev1:jumplev1,jumplev2:jumplev2},r=16*unitsize+"px",n=map.floor;for(e in window.maplines=t=document.createElement("div"),t.style.marginLeft=r,t.id="maplines",o)i=createElement("div",{innerText:e,className:"mapline",id:e+"_line",style:{marginTop:(n-o[e])*unitsize+"px",marginLeft:"-"+r,paddingLeft:r}}),t.appendChild(i);body.appendChild(t)}function setEditorControls(e){e=e||["load","save","reset","undo"];var t,i,o,r=document.getElementById("controls"),n=createElement("div",{id:"controls"}),d=editor.controls={container:n};for(o in r&&(r.innerHTML=""),e)t=e[o],i=createElement("div",{id:t,alt:t,className:"control",style:{backgroundImage:"url(Theme/"+t+".gif)"},innerHTML:"<div class='controltext'>"+t+"</div>",onclick:editorClickControl}),n.appendChild(i),d[t]=i;sidebar.appendChild(n)}function setEditorTriggers(){var e,t=[maplines,canvas];for(e=t.length-1;e>=0;--e)t[e].onclick=editorMouseClick;document.onmousemove=editorFollowerFollowsCursor}function editorMouseClick(e){if(window.editing&&!editor.clicking){if(editorPreventClicks(),editor.erasing)return editorPlaceEraser(e);if(!editor.in_settings&&editor.canplace){var t=editor.section_name,i=(window[t],editor.current_selected,editor.follower);editor.placed.push(i),editor.follower=!1,editorSetCurrentThingFromName(null,!0),paused&&refillCanvas(),i.was_follower=!0,delete i.onclick,editor.playing&&(thingRetrieveVelocity(i),proliferate(i,i.reference.attributes))}}}function editorSelectSection(){var e=(this||editor.sectionselect).value.toLowerCase();(editor.in_settings="settings"==e)?(editorSetSection(e,!0),editorSetSectionSettings()):editorSetSection(e)}function editorSetSection(e,t){var i,o,r=editor.section=editor[e],n=editor.bottombar,d=0;if(editor.section_name=e,n.innerHTML="",!t)for(e in r)++d,o=editorAddBottomPreview(n,e,r[e]),i||(i=o);d?(n.style.visibility="visible",editorSetCurrentThingFromCanvas(i)):n.style.visibility="hidden"}function editorAddBottomPreview(e,t,i){var o,r=i.width,n=i.height,d=window[t],a=d?ThingCreate(d,i.previewargs):new Thing(Sprite,t),l=createElement("div",{width:r*unitsize+"px",height:n*unitsize+"px",name:t,className:"holder "+t,onclick:editorSetCurrentThing}),s=proliferate(getCanvas(r*unitsizet2,n*unitsizet2),{name:t,reference:i,style:{marginLeft:-roundDigit(r/2,scale)+"px"},onclick:editorSetCurrentThing}),c=(e.things,r*unitsizet2),u=n*unitsizet2,p=s.getContext("2d");return canvasDisableSmoothing(s),editor.bottombar.things[t]=s.thing=a,addClass(a,"editor"),o=a.canvas,a.canvases&&(o=a.canvases[i.sprite_source||"middle"].canvas),i.previewsize?(p.fillStyle=p.createPattern(o,"repeat"),p.fillRect(0,0,c,u)):p.drawImage(o,0,0,c,u),l.appendChild(l.canvas=s),e.appendChild(l),e[t]=l,s}function editorSetSectionSettings(){var e,t=editor.settings,i="<table>";i+="<h3 class='title'>Settings</h3>",i+=addArgumentOption("night",Boolean,t.night),i+=addArgumentOption("setting",["Overworld","Underworld","Underwater","Castle","Sky"],t.setting),i+=addArgumentOption("alt",Boolean,t.alt),i+="</table>",options.innerHTML=i,ensureOptionsAboveZero(editorUpdateSettingsOption),e=editor.sidebar.getElementsByTagName("table")[0].rows,editor.settings.night_elem=e[0].cells[1].firstChild,editor.settings.setting_elem=e[1].cells[1].firstChild,editor.settings.alt_elem=e[2].cells[1].firstChild,editor.follower&&killNormal(editor.follower),editor.follower=!1}function editorUpdateSettingsOption(e){var t=editor.settings,i=t.night="True"==t.night_elem.value,o=t.alt="True"==t.alt_elem.value,r=(t.setting=t.setting_elem.value)+(i?" Night":"")+(o?" "+o:"");setAreaSetting(area,r,r!=area.setting)}function editorSetCurrentThing(e,t){var i=e.target,o=editor.current_thing_name=i.name,r=editor.current_thing=editor.section[o];t||updateCurrentArguments(o,r),editorUpdateFollower()}function editorSetCurrentThingFromCanvas(e,t){editorSetCurrentThing({target:e},t)}function editorSetCurrentThingFromName(e,t){editorSetCurrentThing({target:{name:e||editor.current_thing_name}},t)}function updateCurrentArguments(e,t){t=t||{};var i,o=editor.options,r="<table>",n=t.mydefaults||{},arguments=t.arguments||{};for(i in r+="<h3 class='title'>"+e+"</h3>",arguments.width||(r+=addStaticOption("width",t.width)),arguments.height||(r+=addStaticOption("height",t.height)),arguments)r+=addArgumentOption(i.replace("_","-"),arguments[i],null,n);r+="</table>",o.innerHTML=r,ensureOptionsAboveZero()}function addStaticOption(e,t){return t==1/0&&(t="Inf."),"<tr id='option_"+e+"' class='auto'><td>"+e+": </td><td class='auto'>"+t+"</td></tr>"}function addArgumentOption(e,t,o,r){r=r||{};var n="<tr name='"+e+"' id='option_"+e+"'><td>"+e+": </td><td>";switch(t){case 1/0:n+="Inf";break;case Boolean:n+="<select name='"+e+"' value='"+(t?"true":"false")+"'><option>False</option><option>True</select>";break;case Number:n+="<input name='"+e+"' value='"+String(t||0)+"' type='Number'>";break;default:switch(typeof t){case"number":n+="<span class='optspan'>"+t+"x</span><input name='"+e+"' type='Number' class='text' value='"+(r[e]||1)+"'>";break;case"string":n+="<input name='"+e+"' type='text' class='text wide' value='"+t+"'>";break;case"object":for(i in n+="<select name='"+e+"'>",t)n+="<option>"+t[i]+"</option>";n+="<select>"}}return n+"</td></tr>"}function ensureOptionsAboveZero(e){e=e||editorUpdateFollower;var t,o=editor.options.getElementsByTagName("input");for(i=o.length-1;i>=0;--i)(t=o[i]).onchange=t.onclick=t.onkeypress=editorInputEnsureAboveZero;for(o=options.getElementsByTagName("select"),i=o.length-1;i>=0;--i)(t=o[i]).onchange=t.onclick=t.onkeypress=editorUpdateFollower}function editorInputEnsureAboveZero(e){editorUpdateFollower(e)}function editorUpdateFollower(e){if(editor.in_settings)return editorUpdateSettingsOption(e);var t,i=editor.current_thing;(t=editor.follower)&&(t.id="",killNormal(t)),t=i.createfunc?i.createfunc(editor.current_thing,editorGetArguments()):ThingCreate(window[editor.current_thing_name],i.followerUpdate(editor.current_thing,editorGetArguments())),editor.follower=t,proliferate(t,{id:"follower",libtype:editor.section_name,lookleft:!0,nocollide:!0,reference:i,onclick:editorMouseClick},!0),addThing(t),addClass(t,"editor"),thingRetrieveVelocity(t),thingStoreVelocity(t),editorSetFollowerPosition(t),editor.erasing&&(t.hidden=!0)}function editorGetArguments(){var e=arrayMake(editor.options.getElementsByTagName("input")),t=arrayMake(editor.options.getElementsByTagName("select")),i=e.concat(t);return pairs=generateInputNameValuePairs(i),pairs}function generateInputNameValuePairs(e){var t,i={};for(t in e)i[e[t].name]=e[t].value;return i}function editorFollowerFollowsCursor(e){var t=editor.follower;t&&editorSetFollowerPosition(t,roundFollowerDigit(e.x)+(editor.current_thing.widthoff-editor.offset.x)*unitsize,roundFollowerDigit(e.y)+editor.current_thing.heightoff*unitsize)}function editorSetFollowerPosition(e,t,i){t=t||editor.xloc_old||0,i=i||editor.yloc_old||0,setLeft(e,t),setTop(e,i),editor.xloc_old=t,editor.yloc_old=i}function roundFollowerDigit(e){var t="solids"==editor.section_name?8:4;return unitsize*t*round(e/(unitsize*t))}function roundFollowerPosition(e,t){editorSetFollowerPosition(e,roundFollowerDigit(e.left),roundFollowerDigit(e.top))}function editorFollowerUpdateStandard(e,t){"True"==t.hidden&&TimeHandler.addEvent((function(){editor.follower.hidden=!0}));var i=[];return t.width&&i.push(Number(t.width)),t.height&&i.push(Number(t.height)),i}function editorClickControl(e){editorPreventClicks();var t=e.target;t.id||(t=t.parentNode),window["editorControl"+capitalizeFirst(t.id)](),e.preventDefault()}function editorPreventClicks(){editor.clicking=!0,TimeHandler.addEvent(editorClickOff,3)}function editorClickOff(){window.editor&&(editor.clicking=!1)}function editorControlUndo(){var e=editor.placed.pop();e&&!e.player&&killNormal(e)}function editorControlReset(){var e=editor.placed.length,t=roundDigit(35/e,21);TimeHandler.addEventInterval(editorControlUndo,t,e)}function editorControlSave(){var e=editor.rawfunc=editorGetRawFunc();editorCreateInputWindow("<span style='font-size:1.4em;'>Hit Submit below to start playing!</span><br><p style='font-size:.7em;line-height:140%'>This map will be resumed automatically the next time you use the editor on this computer.<br>Alternately, you may copy this text to work on again later using Load (the button next to Save). </p>",e,editorSubmitGameFuncPlay);return e}function editorControlCancel(){loadEditor()}function editorGetRawFunc(){var e,t=editor.placed,i=t.length-1,o=new Array(e),r="  var map = arguments[0] || new Map();\n";for(r+="\n  map.time = "+data.time.amount+";",r+="\n  map.locs = [ new Location(0, true) ];",r+="\n  map.areas = [",r+="\n    new Area('"+area.setting+"', function() {",r+="\n      setLocationGeneration(0);\n\n",e=i;e>=0;--e)o[e]=new editorPreStatement(t[e]);for(o.sort(prethingsorter),e=i;e>=0;--e)o[e]="      "+o[e].statement;return r+=(o=removeDuplicates(o)).join("\n"),r+="\n    })",r+="\n  ];",r+="\n  return map;"}function editorPreStatement(e){this.placer=e,this.xloc=(gamescreen.left+e.left)/unitsize,this.yloc=map.floor-e.top/unitsize,this.statement=editorGetStatement(this,e,e.reference,e.args)}function editorGetStatement(e,t,i,o){if(!i&&!(i=editor[t.libtype][t.title]))return"";var r,n,d=(i.prefunc||pushPreThing).name,a=o.length;if(i.prefunc_custom)d+="("+i.prefunc_custom(e,t,i,o)+");";else{r=[],i.prefunc_solo||r.push(t.title),r.push(String(e.xloc)),r.push(String(e.yloc));for(var l=1;l<a;++l){switch(typeof(n=o[l])){case"undefined":break;case"number":n=String(round(n));break;default:n=String(n)}void 0!==n&&r.push(n)}d+="("+r.join(", ")+");"}return d}function editorControlErase(){editor.erasing?editorControlEraseOff():editorControlEraseOn()}function editorControlEraseOn(){editor.erasing=editor.follower.hidden=!0,classAdd(body,"erasing"),classAdd(editor.controls.erase,"enabled")}function editorControlEraseOff(){editor.erasing=editor.follower.hidden=!1,classRemove(body,"erasing"),classRemove(editor.controls.erase,"enabled")}function editorPlaceEraser(e){addThing(Eraser,e.x,e.y)}function Eraser(e){e.width=e.height=2,e.nocollide=e.nofall=!0,e.movement=eraserErases,setCharacter(e,"eraser")}function eraserErases(e){if(window.editor){var t,i,o=editor.placed,r=o.concat(solids).concat(characters).concat(scenery);for(i=r.length-1;i>=0;--i)if(!(t=r[i]).player&&t!=editor.follower&&objectsTouch(e,t)){killNormal(t),o.splice(o.indexOf(t),1);break}killNormal(e)}}function editorControlLoad(){editorCreateInputWindow("Paste your work in progress here, and click Submit to continue it.","",editorSubmitLoad)}function addThingsToPlaced(){var e=editor.placed;for(editor.placed=(editor.placed||[]).concat(characters).concat(solids).concat(scenery),e.sort(prethingsorter),e.splice(e.indexOf(player),1),i=e.length-1;i>=0;--i)placer=e[i],placer.reference=editor[placer.libtype][placer.title]}function editorCreateInputWindow(e,t,i){var o=gamescreen.unitwidth,r=editor.input_window=createElement("div",{id:"input_window",innerHTML:e||"",style:{width:o+"px"}}),n=r.input=editor.window_input=createElement("textarea",{id:"window_input",value:t||"",style:{width:o-49+"px"}}),d=r.submit=createElement("div",{id:"window_submit",className:"window_button",innerText:"Submit",onclick:i}),a=r.cancel=createElement("div",{id:"window_cancel",className:"window_button",innerText:"Cancel",onclick:editorCloseInputWindow});return r.appendChild(n),r.appendChild(d),r.appendChild(a),body.appendChild(r),killNormal(editor.follower=!1),editor.follower=!1,r}function editorCloseInputWindow(e){editorPreventClicks(),removeChildSafe(window.input_window,body),e||(editorSetCurrentThingFromName(),window.editing=!0),editorUpdateFollower()}function editorClose(e){if(window.editor){classRemove(body,"editor"),classRemove(body,"erasing"),killNormal(editor.follower),editor.follower=!1,delete window.editor;var t,i=["maplines","sidebar","bottombar","scrollers"];for(t in i)removeChildSafe(document.getElementById(i[t]),body);document.onmousemove=null,window.editing=!1,e&&window.map&&(map.shifting=!1)}}function scrollEditor(e,t){window.editor&&(editor.follower&&(e=e||0,t=t||0,shiftAll(scenery,e,t),shiftAll(solids,e,t),shiftAll(characters,e,t),editor.xloc+=e,editor.yloc+=t))}function editorStoreLocally(){localStorage.editorLastFunc=editor.rawfunc}function setEditorLocalRetrieval(){localStorage.editorLastFunc&&(editor.rawfunc=round,editorSubmitGameFunc())}function editorSubmitGameFunc(){if(!window.editor||!editor.rawfunc)return loadEditor();editor.rawfunc;var e=window.custommapfunc=new Function(editor.rawfunc);mapfuncs.Custom={Map:e},window.canedit=!0,setMap(["Custom","Map"]),window.canedit=editor.playing=!1,entryBlank(player),addThingsToPlaced(),editorStoreLocally(),editorCloseInputWindow()}function editorSubmitGameFuncPlay(){editorPreventClicks(),editorSubmitGameFunc(),editorStartPlaying()}function editorSubmitLoad(){if(window.editor&&editor.window_input){editorPreventClicks();var e=editor.window_input.value;loadEditor(),editor.rawfunc=e,editorSubmitGameFunc()}}function editorStartPlaying(){editorPreventClicks(),editor.playing=!0,placePlayer(),entryPlain(player),nokeys=!1;var e,t,i,o=editor.placed;for(i in o)e=o[i],thingRetrieveVelocity(e),(t=editor[e.libtype][e.title])&&proliferate(e,t.onadds);setEditorControls(["Cancel"])}function setEditorLocalRetrieval(){var e=localStorage.editorLastFunc;if(e){editor.rawfunc=e,editorSubmitGameFunc(),editorStoreLocally();var t,i=editor.placed;for(t in i)thingStoreVelocity(i[t])}}